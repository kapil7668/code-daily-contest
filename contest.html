<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CodeRush Contest ‚Äì Details</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    /* CSS HIDE REMOVED - BUTTONS VISIBLE HAINGE */
  </style>
</head>

<body class="min-h-screen text-slate-100 bg-slate-950
             bg-[radial-gradient(circle_at_top,_rgba(45,212,191,0.20),_transparent_52%),radial-gradient(circle_at_bottom,_rgba(37,99,235,0.20),_transparent_55%)]">

<!-- Navbar -->
<header class="border-b border-slate-800 bg-slate-950/90 backdrop-blur sticky top-0 z-30">
  <nav class="max-w-5xl mx-auto flex items-center justify-between px-4 py-3 text-xs">
    <div class="flex items-center gap-2">
      <a href="dashboard.html" class="flex items-center gap-2">
        <div class="h-7 w-7 rounded-xl bg-gradient-to-br from-emerald-400 to-cyan-500 flex items-center justify-center text-slate-900 font-extrabold">
          C
        </div>
        <span class="font-semibold text-sm tracking-tight">CodeRush</span>
      </a>
      <span class="mx-2 text-slate-600">/</span>
      <span id="contest-short" class="text-slate-300"></span>
    </div>
    <button onclick="history.back()"
            class="hidden sm:inline px-3 py-1.5 rounded-lg border border-slate-700 text-slate-300 hover:border-slate-500 text-[11px]">
      ‚Üê Back
    </button>
  </nav>
</header>

<main class="max-w-5xl mx-auto px-4 py-5 md:py-7 text-xs md:text-sm
             bg-slate-900/80 border border-slate-800/70 rounded-2xl shadow-[0_0_32px_rgba(15,23,42,0.95)] mt-4 mb-8">

  <!-- Loading -->
  <div id="loading" class="flex items-center justify-center py-12">
    <div class="animate-spin h-8 w-8 border-4 border-emerald-400 border-t-transparent rounded-full"></div>
  </div>

  <!-- Main content -->
  <section id="contest-content" class="hidden">
    <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-4 mb-5">

      <!-- LEFT -->
      <div class="flex-1 space-y-4">
        <div>
          <p id="badge" class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] border border-emerald-400/60 text-emerald-300 mb-2"></p>
          <h1 id="contest-title" class="text-lg md:text-2xl font-bold mb-2"></h1>
          <p id="contest-subtitle" class="text-slate-300 text-[11px] md:text-xs max-w-xl"></p>
        </div>

        <!-- Contest details -->
        <section id="contest-details"
                 class="space-y-3 text-sm text-slate-200 bg-slate-900/60 border border-slate-800 rounded-2xl p-4">
          <h2 class="text-sm font-semibold mb-1">Contest details</h2>

          <p class="text-[11px] text-slate-300">
            Entry: <span id="detail-entry-fee" class="font-semibold text-slate-100"></span> ‚Ä¢
            Min participants: <span id="detail-min-participants" class="font-semibold text-slate-100"></span> ‚Ä¢
            Total prize: <span id="detail-total-prize" class="font-semibold text-amber-300"></span>
          </p>

          <div class="mt-1">
            <h3 class="text-[11px] uppercase tracking-wide text-slate-400 mb-1">Prize breakdown</h3>
            <ul id="detail-payouts" class="text-[11px] text-slate-200 space-y-1"></ul>
          </div>

          <p class="text-[11px] text-slate-400">
            Prize distribution contest khatam hone ke 24‚Äì48 ghante ke andar UPI / bank ke through hogi.
          </p>
        </section>
      </div>

      <!-- RIGHT -->
      <div class="bg-slate-900/80 border border-slate-700 rounded-xl p-3 min-w-[260px]">
        <h2 class="text-[11px] font-semibold mb-2 text-slate-200">When & duration</h2>
        <p id="contest-time" class="text-slate-300 text-[11px] mb-1"></p>
        <p id="contest-duration" class="text-slate-400 text-[11px] mb-3"></p>

        <div class="flex items-center justify-between text-[11px] mb-3">
          <span id="contest-level" class="px-2 py-0.5 rounded-full border border-slate-600 text-slate-200"></span>
          <span id="contest-prize" class="text-amber-300 text-right"></span>
        </div>

        <!-- Free button -->
        <button id="free-register-btn"
                class="w-full mb-2 px-3 py-1.5 rounded-lg bg-emerald-500 hover:bg-emerald-400 text-slate-900 text-[11px] font-semibold">
          Register for free
        </button>

        <!-- Paid contest -->
        <div id="paid-contest-section" class="hidden">
          <div class="mb-4 p-4 bg-gradient-to-r from-orange-500/10 to-amber-500/10 border border-orange-400/30 rounded-xl">
            <h3 class="font-bold mb-3 text-orange-300">Choose Entry Amount</h3>

            <div class="grid grid-cols-2 md:grid-cols-3 gap-2 mb-3">
              <button data-amount="9"  class="entry-btn px-3 py-2 rounded-lg border border-slate-600 text-slate-100 text-sm">‚Çπ9</button>
              <button data-amount="49" class="entry-btn px-3 py-2 rounded-lg border border-slate-600 text-slate-100 text-sm">‚Çπ49</button>
              <button data-amount="99" class="entry-btn px-3 py-2 rounded-lg border border-emerald-400 bg-emerald-500/10 text-emerald-200 text-sm">‚Çπ99</button>
              <button data-amount="149" class="entry-btn px-3 py-2 rounded-lg border border-slate-600 text-slate-100 text-sm">‚Çπ149</button>
              <button data-amount="199" class="entry-btn px-3 py-2 rounded-lg border border-slate-600 text-slate-100 text-sm">‚Çπ199</button>
            </div>

            <div id="pay-area" class="mt-1"></div>

            <div id="razorpay-container" class="hidden bg-gradient-to-r from-emerald-500/20 to-green-500/20 p-3 rounded-xl border-2 border-emerald-400/50 mt-3">
              <div class="text-center mb-2">
                <div class="inline-flex items-center gap-2 bg-emerald-500/20 px-3 py-1 rounded-full text-emerald-300 text-[11px] font-medium">
                  Secure payment via Razorpay
                </div>
              </div>
              <form id="payment-form"></form>
            </div>
          </div>
        </div>

        <!-- Success / already registered -->
        <div id="successMsg" class="hidden bg-green-100/90 backdrop-blur-sm p-4 rounded-xl mt-4 border-2 border-green-400/50">
          <p class="font-bold text-sm text-green-800 mb-1">Payment Successful!</p>
          <p class="text-[11px] text-green-700 mb-1">‚Çπ<span id="paidAmount">99</span> ‡§ï‡§æ payment successful.</p>
          <p class="text-[11px] text-green-600 font-medium">Contest ‡§Æ‡•á‡§Ç register ‡§π‡•ã ‡§ó‡§è! Exam abhi start ho raha hai.</p>
        </div>

        <div id="registeredBadge" class="hidden bg-blue-100/90 backdrop-blur-sm p-4 rounded-xl mt-4 border-2 border-blue-400/50">
          <span class="font-bold text-blue-800 text-[12px]">‚úì Already registered for this contest</span>
        </div>

        <button id="secondary-btn"
                class="w-full mt-3 px-3 py-1.5 rounded-lg border border-slate-600 text-slate-200 text-[11px]">
          Add to calendar
        </button>
      </div>
    </div>

    <!-- Format / scoring / eligibility -->
    <section class="grid md:grid-cols-3 gap-4 mb-6">
      <div class="bg-slate-900 rounded-xl border border-slate-800 p-3">
        <h3 class="font-semibold mb-1 text-xs">Format</h3>
        <p id="contest-format" class="text-[11px] text-slate-300"></p>
      </div>
      <div class="bg-slate-900 rounded-xl border border-slate-800 p-3">
        <h3 class="font-semibold mb-1 text-xs">Scoring</h3>
        <p id="contest-scoring" class="text-[11px] text-slate-300"></p>
      </div>
      <div class="bg-slate-900 rounded-xl border border-slate-800 p-3">
        <h3 class="font-semibold mb-1 text-xs">Eligibility</h3>
        <p id="contest-eligibility" class="text-[11px] text-slate-300"></p>
      </div>
    </section>

    <!-- Rules / languages -->
    <section class="grid md:grid-cols-2 gap-4 text-[11px] md:text-xs">
      <div class="bg-slate-900 rounded-xl border border-slate-800 p-3">
        <h3 class="font-semibold mb-2 text-xs">Rules</h3>
        <ul id="contest-rules" class="list-disc list-inside space-y-1 text-slate-300"></ul>
      </div>
      <div class="bg-slate-900 rounded-xl border border-slate-800 p-3">
        <h3 class="font-semibold mb-2 text-xs">Languages & platform</h3>
        <ul id="contest-langs" class="list-disc list-inside space-y-1 text-slate-300"></ul>
      </div>
    </section>
  </section>
</main>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="contests-config.js"></script>

<script>
const SUPABASE_URL = "https://tghtgygjawhrcgtwhrej.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRnaHRneWdqYXdocmNndHdocmVqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5OTM0MjksImV4cCI6MjA4MTU2OTQyOX0.Q-Ht_IFcPZPIHO5905o70EDya2yFdVP-9LjDmjkle38";

const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// COMPLETE PRIZE CONFIGS - TOP10 vs TOP100
const prizeConfigs = {
  top10: {
    9: { entryFee: 9, minParticipants: 50, totalPrize: 250, payouts: [{fromRank:1,toRank:1,amount:100}, {fromRank:2,toRank:2,amount:50}, {fromRank:3,toRank:3,amount:25}] },
    49: { entryFee: 49, minParticipants: 75, totalPrize: 1000, payouts: [{fromRank:1,toRank:1,amount:400}, {fromRank:2,toRank:3,amount:100}, {fromRank:4,toRank:10,amount:25}] },
    99: { entryFee: 99, minParticipants: 100, totalPrize: 2000, payouts: [{fromRank:1,toRank:1,amount:800}, {fromRank:2,toRank:2,amount:400}, {fromRank:3,toRank:3,amount:200}, {fromRank:4,toRank:10,amount:50}] },
    149: { entryFee: 149, minParticipants: 150, totalPrize: 3500, payouts: [{fromRank:1,toRank:1,amount:1500}, {fromRank:2,toRank:5,amount:300}] },
    199: { entryFee: 199, minParticipants: 200, totalPrize: 5000, payouts: [{fromRank:1,toRank:1,amount:2500}, {fromRank:2,toRank:3,amount:500}, {fromRank:4,toRank:10,amount:100}] }
  },
  top100: {
    99: { entryFee: 99, minParticipants: 200, totalPrize: 5000, payouts: [{fromRank:1,toRank:1,amount:1000}, {fromRank:2,toRank:10,amount:200}, {fromRank:11,toRank:100,amount:25}] }
  }
};

// RAZORPAY BUTTON IDs - TOP10 vs TOP100
const buttonIds = {
  top10: {
    9: "pl_Rt0YF2KK1nRmrO",
    49: "pl_Rt0aENCzk6VBW6",
    99: "pl_Rt0ToHijWYJDr6",
    149: "pl_Rt0bZgbs4Ry3Io",
    199: "pl_Rt0dtv8GdORMh6"
  },
  top100: {
    9: "pl_Rt0YF2KK1nRmrO",
    49: "pl_Rt0aENCzk6VBW6",
    99: "pl_RwlDC6dl5SVEpC",  // Different ID for Top100
    149: "pl_Rt0bZgbs4Ry3Io",
    199: "pl_Rt0dtv8GdORMh6"
  }
};

// Static text for free/paid
const contests = {
  free: {
    short: "Free Daily Rush",
    badge: "Featured ‚Ä¢ Free",
    title: "Free Daily Rush ‚Äì 3 Problems in 60 Minutes",
    subtitle: "Best daily habit builder. Solve 3 hand‚Äëpicked DSA problems with live leaderboard and CodeRush rating update.",
    time: "Everyday ‚Ä¢ 8:00 PM IST (India time)",
    duration: "Duration: 60 minutes ‚Ä¢ 3 problems ‚Ä¢ Mixed difficulty",
    level: "Level: Beginner to Intermediate",
    prize: "No entry fee ‚Ä¢ virtual rewards & badges",
    format: "3 problems: 1 Easy, 1 Medium, 1 slightly tricky Medium. All problems are from CodeRush curated sets.",
    scoring: "Score = sum of problem scores ‚Äì penalties for wrong submissions. Faster correct submissions get slightly higher weight.",
    eligibility: "Open for all registered CodeRush users. Ideal for college students and working professionals.",
    rules: [
      "Multiple submissions allowed; last correct submission counts.",
      "Cheating, code sharing or using multiple accounts can lead to disqualification.",
      "Ties are broken by total time and then by earliest correct submissions."
    ],
    langs: [
      "Supported languages: C++, Java, Python (more coming soon).",
      "You must write and submit code on CodeRush problem page.",
      "Internet connection and modern browser required."
    ]
  },
  paid: {
    short: "Paid Mega Contest",
    badge: "Pro ‚Ä¢ Paid",
    title: "Paid Mega Contest ‚Äì High Rated DSA Challenge",
    subtitle: "Serious 2‚Äëhour contest with tough DSA questions and cash prizes for the top leaderboard positions.",
    time: "Every Sunday ‚Ä¢ 7:00 PM IST (India time)",
    duration: "Duration: 120 minutes ‚Ä¢ 4 problems ‚Ä¢ Medium‚ÄìHard",
    level: "Level: Intermediate to Advanced",
    prize: "Entry fee via Razorpay ‚Ä¢ cash prizes + goodies",
    format: "4 problems focusing on core DSA: DP, graphs, greedy, advanced arrays. Problems are unique to this contest.",
    scoring: "Each problem has fixed score. Wrong submissions may incur small penalty. Final rank based on total score, then total time.",
    eligibility: "Open for Indian users (18+) with valid payment method. Students & working professionals both can participate.",
    rules: [
      "One account per participant; sharing solutions during contest is strictly prohibited.",
      "Refunds only if contest is cancelled due to technical reasons.",
      "Winners may need to complete basic KYC for prize distribution."
    ],
    langs: [
      "Supported languages: C++, Java, Python.",
      "Submissions and judging happen on CodeRush online judge.",
      "Stable internet and latest Chrome/Edge recommended."
    ]
  }
};

// URL params
const pageParams = new URLSearchParams(window.location.search);
let selectedAmount = Number(pageParams.get("amount")) || 99;
const variant = pageParams.get("variant") || "top10";

document.addEventListener("DOMContentLoaded", async () => {
  const { data, error } = await supabaseClient.auth.getUser();
  if (error || !data.user) {
    window.location.href = "index.html";
    return;
  }

  document.getElementById("loading").style.display = "none";
  document.getElementById("contest-content").classList.remove("hidden");

  const type = pageParams.get("type") === "paid" ? "paid" : "free";
  const c = contests[type];

  // Update title based on variant
  if (type === "paid" && variant === "top100") {
    c.title = "Paid Mega Top100 ‚Äì Cash Prizes for Top 100";
    c.subtitle = "Weekend mega contest with Top 100 cash prize winners.";
  }

  document.getElementById("contest-short").textContent = c.short;
  document.getElementById("badge").textContent = c.badge;
  document.getElementById("contest-title").textContent = c.title;
  document.getElementById("contest-subtitle").textContent = c.subtitle;
  document.getElementById("contest-time").textContent = c.time;
  document.getElementById("contest-duration").textContent = c.duration;
  document.getElementById("contest-level").textContent = c.level;
  document.getElementById("contest-prize").textContent = c.prize;
  document.getElementById("contest-format").textContent = c.format;
  document.getElementById("contest-scoring").textContent = c.scoring;
  document.getElementById("contest-eligibility").textContent = c.eligibility;

  const rulesUl = document.getElementById("contest-rules");
  c.rules.forEach((r) => {
    const li = document.createElement("li");
    li.textContent = r;
    rulesUl.appendChild(li);
  });

  const langsUl = document.getElementById("contest-langs");
  c.langs.forEach((r) => {
    const li = document.createElement("li");
    li.textContent = r;
    langsUl.appendChild(li);
  });

  if (type === "paid") {
    document.getElementById("paid-contest-section").classList.remove("hidden");
    document.getElementById("free-register-btn").style.display = "none";
    setupEntryButtons();
    await checkRegistrationStatus("paid");
  } else {
    document.getElementById("free-register-btn").onclick = registerFreeContest;
    document.getElementById("paid-contest-section").style.display = "none";
  }

  const success = pageParams.get("success");
  const successAmount = pageParams.get("amount");
  if (type === "paid" && success === "1" && successAmount) {
    await handleRazorpaySuccess(Number(successAmount));
    document.getElementById("paidAmount").textContent = successAmount;
  }
});

// FIXED: SAARRE ENTRY BUTTONS SHOW + Top10/Top100 support
function setupEntryButtons() {
  document.querySelectorAll(".entry-btn").forEach((btn) => {
    btn.classList.remove("hidden");  // ALL BUTTONS VISIBLE
    btn.addEventListener("click", () => updateSelectedEntry(Number(btn.dataset.amount)));
  });
  updateSelectedEntry(selectedAmount);
}

function updateSelectedEntry(amount) {
  selectedAmount = amount;
  document.querySelectorAll(".entry-btn").forEach((btn) => {
    const a = Number(btn.dataset.amount);
    if (a === amount) {
      btn.classList.add("border-emerald-400", "bg-emerald-500/20", "text-emerald-200", "ring-2", "ring-emerald-400/50");
      btn.classList.remove("border-slate-600", "text-slate-100");
    } else {
      btn.classList.remove("border-emerald-400", "bg-emerald-500/20", "text-emerald-200", "ring-2", "ring-emerald-400/50");
      btn.classList.add("border-slate-600", "text-slate-100");
    }
  });
  renderContestDetails(amount);
  renderPayButton(amount);
}

function renderPayButton(amount) {
  const payArea = document.getElementById("pay-area");
  payArea.innerHTML = `
    <button id="pay-btn"
      class="w-full px-6 py-2.5 rounded-xl bg-gradient-to-r from-emerald-500 to-green-500 text-slate-900 font-bold text-sm hover:from-emerald-600 hover:to-green-600 shadow-lg transform hover:scale-[1.02] transition-all duration-200">
      üí≥ Pay ‚Çπ${amount} ‚Üí Join Contest
    </button>
  `;
  const payBtn = document.getElementById("pay-btn");
  if (payBtn) {
    payBtn.onclick = () => {
      loadPaymentButton(amount);
      document.getElementById("paidAmount").textContent = amount;
    };
  }
}

function loadPaymentButton(amount) {
  const currentVariant = pageParams.get("variant") || "top10";
  const paymentId = buttonIds[currentVariant][amount];
  
  if (!paymentId) {
    alert(`‚Çπ${amount} payment button not configured for ${currentVariant}. Check Razorpay dashboard.`);
    return;
  }
  
  const form = document.getElementById("payment-form");
  form.innerHTML = "";
  const script = document.createElement("script");
  script.src = "https://checkout.razorpay.com/v1/payment-button.js";
  script.async = true;
  script.dataset.payment_button_id = paymentId;
  form.appendChild(script);
  document.getElementById("razorpay-container").classList.remove("hidden");
}

function getConfigForAmount(amount) {
  const currentVariant = pageParams.get("variant") || "top10";
  return prizeConfigs[currentVariant]?.[amount] || prizeConfigs.top10[amount];
}

function renderContestDetails(amount) {
  const config = getConfigForAmount(amount);
  if (!config) {
    document.getElementById("detail-entry-fee").textContent = `‚Çπ${amount}`;
    return;
  }

  document.getElementById("detail-entry-fee").textContent = `‚Çπ${config.entryFee}`;
  document.getElementById("detail-min-participants").textContent = config.minParticipants;
  document.getElementById("detail-total-prize").textContent = `‚Çπ${config.totalPrize}`;

  const ul = document.getElementById("detail-payouts");
  ul.innerHTML = "";
  config.payouts.forEach((p) => {
    if (p.fromRank === p.toRank) {
      const li = document.createElement("li");
      li.textContent = `Rank ${p.fromRank}: ‚Çπ${p.amount}`;
      ul.appendChild(li);
    } else {
      for (let r = p.fromRank; r <= p.toRank; r++) {
        const li = document.createElement("li");
        li.textContent = `Rank ${r}: ‚Çπ${p.amount}`;
        ul.appendChild(li);
      }
    }
  });
}

// Supabase helpers
function showSuccessMessage() {
  document.getElementById("successMsg").classList.remove("hidden");
  document.getElementById("razorpay-container").style.display = "none";
}

async function registerInSupabase(amount = "99") {
  const { data, error } = await supabaseClient.auth.getUser();
  if (!error && data.user) {
    await supabaseClient.from("contest_registrations").insert({
      user_id: data.user.id,
      contest_type: "paid",
      contest_variant: pageParams.get("variant") || "top10",
      amount_paid: parseInt(amount),
      payment_status: "success",
      timestamp: new Date().toISOString()
    });
  }
}

async function handleRazorpaySuccess(amount) {
  await registerInSupabase(amount);
  showSuccessMessage();

  setTimeout(() => {
    const variantParam = pageParams.get("variant") || "top10";
    window.location.href = `exam.html?type=paid&amount=${amount}&variant=${variantParam}`;
  }, 1500);
}

async function checkRegistrationStatus(type) {
  const { data, error } = await supabaseClient.auth.getUser();
  if (!error && data.user && type === "paid") {
    const variantParam = pageParams.get("variant") || "top10";
    const { data: reg } = await supabaseClient
      .from("contest_registrations")
      .select("*")
      .eq("user_id", data.user.id)
      .eq("contest_type", "paid")
      .eq("contest_variant", variantParam)
      .maybeSingle();
    if (reg) {
      document.getElementById("registeredBadge").classList.remove("hidden");
      document.getElementById("razorpay-container").style.display = "none";
    }
  }
}

async function registerFreeContest() {
  const { data, error } = await supabaseClient.auth.getUser();
  if (!error && data.user) {
    await supabaseClient.from("contest_registrations").insert({
      user_id: data.user.id,
      contest_type: "free",
      payment_status: "free"
    });

    window.location.href = "exam.html?type=free";
  }
}
</script>

</body>
</html>
