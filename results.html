<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Contest Result – CodeRush</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
  </style>
</head>

<body class="min-h-screen text-slate-100 bg-slate-950
             bg-[radial-gradient(circle_at_top,_rgba(45,212,191,0.23),_transparent_52%),radial-gradient(circle_at_bottom,_rgba(37,99,235,0.22),_transparent_55%)]">

<main class="max-w-4xl mx-auto px-4 py-6 mt-6 mb-10 bg-slate-900/85 border border-slate-800/60 rounded-2xl shadow-[0_0_40px_rgba(15,23,42,0.95)]">
  <!-- Header -->
  <div id="result-header" class="flex items-center justify-between mb-4">
    <!-- JS se fill hoga -->
  </div>

  <!-- Overall score card -->
  <section id="score-card" class="mb-5">
    <div class="bg-slate-800/80 border border-slate-700 rounded-2xl px-4 py-3 flex items-center justify-between">
      <div>
        <p class="text-[11px] text-slate-400">Overall score</p>
        <p id="overall-score" class="text-xl font-semibold text-emerald-400">Calculating...</p>
      </div>
      <button onclick="window.location.href='dashboard.html'"
        class="px-3 py-1.5 rounded-lg bg-emerald-500 text-slate-900 text-[11px] font-semibold">
        Back to dashboard
      </button>
    </div>
  </section>

  <!-- Per-question breakdown -->
  <section class="mb-5">
    <h2 class="text-sm font-semibold mb-2">Question wise breakdown</h2>
    <div id="breakdown-body" class="border border-slate-800 rounded-xl overflow-hidden text-xs">
      <div class="px-3 py-2 text-[11px] text-slate-400">Loading breakdown...</div>
    </div>
  </section>

  <!-- Leaderboard (Top 50 of this contest) -->
  <section id="leaderboard" class="mt-4 text-xs">
    <h2 class="text-sm font-semibold mb-2">Contest leaderboard (Top 50)</h2>
    <div id="leaderboard-body" class="border border-slate-800 rounded-xl overflow-hidden">
      <div class="px-3 py-2 text-[11px] text-slate-400">Loading leaderboard...</div>
    </div>
  </section>
</main>

<script src="contests-config.js"></script>
<script>
  // === Supabase client ===
  const SUPABASE_URL = 'https://tghtgygjawhrcgtwhrej.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRnaHRneWdqYXdocmNndHdocmVqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5OTM0MjksImV4cCI6MjA4MTU2OTQyOX0.Q-Ht_IFcPZPIHO5905o70EDya2yFdVP-9LjDmjkle38';
  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // Helpers
  function getContestIdFromUrl() {
    const params = new URLSearchParams(window.location.search);
    return params.get("contestId");
  }

  function findContestById(id) {
    return Array.isArray(CONTESTS) ? CONTESTS.find(c => c.id === id) : null;
  }

  function getScoreFromUrlFallback() {
    const params = new URLSearchParams(window.location.search);
    return Number(params.get("score") || 0);
  }

  function renderHeader(contest, yourScore, maxMarks) {
    const header = document.getElementById("result-header");
    if (!header || !contest) return;

    header.innerHTML = `
      <div>
        <p class="text-[11px] uppercase tracking-wide ${
          contest.type === "free" ? "text-emerald-400" : "text-amber-400"
        } mb-1">
          ${contest.type === "free" ? "Free contest" : "Paid contest"}
        </p>
        <h1 class="text-xl font-semibold mb-1">${contest.title} – Result</h1>
        <p class="text-slate-300 text-xs mb-1">
          Entry ${contest.entryFee === 0 ? "Free" : "₹" + contest.entryFee}
          • Total prize ₹${contest.totalPrize}
          • Top ${contest.maxWinners} students get rewards
        </p>
        <p class="text-emerald-400 text-sm font-semibold">
          Your score: <span id="your-score">${yourScore}</span> / ${maxMarks}
        </p>
      </div>
    `;
  }

  // Main flow: calculate score, show breakdown, save to leaderboard
  async function loadResultPage() {
    const contestId = getContestIdFromUrl();
    const contest = findContestById(contestId);

    if (!contest) {
      document.body.innerHTML = `
        <div class="min-h-screen flex items-center justify-center bg-slate-950 text-slate-100">
          <div class="bg-slate-900 border border-slate-800 rounded-xl px-5 py-4 text-sm">
            <p class="text-red-400 font-semibold mb-2">Invalid contest.</p>
            <a href="dashboard.html" class="text-emerald-400 underline text-xs">Back to dashboard</a>
          </div>
        </div>
      `;
      return;
    }

    try {
      const { data: { user } } = await supabaseClient.auth.getUser();
      if (!user) {
        alert('Please login again.');
        window.location.href = 'index.html';
        return;
      }

      // 1) Submissions for this contest
      const { data: submissions } = await supabaseClient
        .from('submissions')
        .select('question_id, code')
        .eq('user_id', user.id)
        .eq('contest_id', contestId);

      // 2) Problems with marks
      const { data: problems } = await supabaseClient
        .from('problems')
        .select('id, title, marks');  // marks column[web:282]

      // 3) Calculate total score + breakdown rows
      let totalScore = 0;
      const breakdownRows = [];

      const problemMap = {};
      if (problems) {
        problems.forEach(p => { problemMap[p.id] = p; });
      }

      const questionIds = ['q1', 'q2', 'q3']; // fixed 3 questions
      questionIds.forEach((qid, index) => {
        const p = problemMap[qid] || { title: `Question ${index + 1}`, marks: 0 };
        const sub = submissions ? submissions.find(s => s.question_id === qid) : null;
        const attempted = sub && sub.code && sub.code.trim().length > 0;
        const gained = attempted ? (p.marks || 0) : 0;

        totalScore += gained;

        breakdownRows.push({
          id: qid,
          title: p.title,
          marks: p.marks || 0,
          attempted,
          gained
        });
      });

      const fallbackScore = getScoreFromUrlFallback();
      const finalScore = totalScore || fallbackScore;

      // Abhi sab contest 300 marks ke maante hain
      const maxMarks = 300;

      // 4) Render header + overall score
      renderHeader(contest, finalScore, maxMarks);
      document.getElementById('overall-score').textContent = `${finalScore} / ${maxMarks}`;

      // 5) Render breakdown table
      renderBreakdownTable(breakdownRows);

      // 6) Save to leaderboard + show leaderboard
      await saveToLeaderboardAndShow(user.id, contestId, finalScore);

    } catch (err) {
      console.error('Result error', err);
      document.getElementById('overall-score').textContent = 'Error';
      document.getElementById('breakdown-body').innerHTML =
        `<div class="px-3 py-2 text-[11px] text-red-400">Error loading result.</div>`;
      document.getElementById('leaderboard-body').innerHTML =
        `<div class="px-3 py-2 text-[11px] text-red-400">Error loading leaderboard.</div>`;
    }
  }

  function renderBreakdownTable(rows) {
    const body = document.getElementById('breakdown-body');
    if (!body) return;

    if (!rows || rows.length === 0) {
      body.innerHTML = `<div class="px-3 py-2 text-[11px] text-slate-400">No submissions found.</div>`;
      return;
    }

    const htmlRows = rows.map((row, index) => `
      <tr class="border-t border-slate-800">
        <td class="px-3 py-2 text-[11px] text-slate-200">Q${index + 1}</td>
        <td class="px-3 py-2 text-[11px] text-slate-200">${row.title}</td>
        <td class="px-3 py-2 text-[11px] text-center text-slate-100">${row.marks}</td>
        <td class="px-3 py-2 text-[11px] text-center ${row.attempted ? 'text-emerald-400' : 'text-slate-400'}">
          ${row.attempted ? 'Attempted' : 'Not attempted'}
        </td>
        <td class="px-3 py-2 text-[11px] text-center ${row.attempted ? 'text-emerald-400' : 'text-slate-400'}">
          ${row.gained}
        </td>
      </tr>
    `).join('');

    body.innerHTML = `
      <table class="w-full text-[11px]">
        <thead class="bg-slate-800/80 text-slate-300">
          <tr>
            <th class="px-3 py-2 text-left">Q#</th>
            <th class="px-3 py-2 text-left">Question</th>
            <th class="px-3 py-2 text-left">Marks</th>
            <th class="px-3 py-2 text-left">Status</th>
            <th class="px-3 py-2 text-left">Gained</th>
          </tr>
        </thead>
        <tbody class="text-slate-200">
          ${htmlRows}
        </tbody>
      </table>
    `;
  }

  async function saveToLeaderboardAndShow(userId, contestId, score) {
    // Save / update score
    const { error: upsertError } = await supabaseClient
      .from('leaderboard')
      .upsert({ contest_id: contestId, user_id: userId, score: score });

    if (upsertError) {
      console.error('Leaderboard save error:', upsertError);
    } else {
      // Optional RPC for ranks
      try {
        await supabaseClient.rpc('update_leaderboard_ranks', { target_contest_id: contestId });
      } catch (e) {
        console.warn('Rank RPC error (optional):', e);
      }
    }

    // Fetch top 50 for this contest
    const container = document.getElementById('leaderboard-body');
    try {
      const { data: { user } } = await supabaseClient.auth.getUser();

      const { data, error } = await supabaseClient
        .from('leaderboard')
        .select('user_id, score, rank')
        .eq('contest_id', contestId)
        .order('score', { ascending: false })
        .limit(50);   // Top 50[web:291]

      if (error) {
        console.error('Leaderboard fetch error:', error);
        container.innerHTML = `<div class="px-3 py-2 text-[11px] text-red-400">Failed to load leaderboard.</div>`;
        return;
      }

      if (!data || data.length === 0) {
        container.innerHTML = `<div class="px-3 py-2 text-[11px] text-slate-400">No participants yet.</div>`;
        return;
      }

      data.sort((a, b) => b.score - a.score);

      const rowsHtml = data.map((row, index) => {
        const isYou = user && row.user_id === user.id;
        const rank = row.rank || index + 1;

        let displayName = 'User';
        if (isYou) displayName = 'You';
        else if (row.user_id) displayName = row.user_id.slice(0, 6) + '...';

        return `
          <tr class="border-t border-slate-800 ${isYou ? 'bg-emerald-500/10' : 'hover:bg-slate-800/60'}">
            <td class="px-3 py-1.5 text-center text-[11px] ${isYou ? 'text-emerald-400 font-semibold' : ''}">
              ${rank}
            </td>
            <td class="px-3 py-1.5 text-[11px] ${isYou ? 'text-emerald-400 font-semibold' : ''}">
              ${displayName}
            </td>
            <td class="px-3 py-1.5 text-center text-[11px] ${isYou ? 'text-emerald-400 font-semibold' : ''}">
              ${row.score}
            </td>
          </tr>
        `;
      }).join('');

      container.innerHTML = `
        <table class="w-full text-[11px]">
          <thead class="bg-slate-800/80 text-slate-300">
            <tr>
              <th class="px-3 py-1.5 text-left">Rank</th>
              <th class="px-3 py-1.5 text-left">Student</th>
              <th class="px-3 py-1.5 text-left">Score</th>
            </tr>
          </thead>
          <tbody class="text-slate-200">
            ${rowsHtml}
          </tbody>
        </table>
      `;
    } catch (e) {
      console.error('Leaderboard render error:', e);
      container.innerHTML = `<div class="px-3 py-2 text-[11px] text-red-400">Error loading leaderboard.</div>`;
    }
  }

  document.addEventListener("DOMContentLoaded", loadResultPage);
</script>

</body>
</html>
