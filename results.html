<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Result - CodeRush</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.48.0/dist/umd/supabase.min.js"></script>
  <style>
    * { font-family: system-ui, -apple-system, sans-serif; }
    .glass { backdrop-filter: blur(20px); }
  </style>
</head>
<body class="bg-gradient-to-br from-slate-900 to-slate-950 text-slate-100 min-h-screen">
  
  <!-- Navbar -->
  <header class="border-b border-slate-800/50 bg-slate-900/95 glass sticky top-0 z-50">
    <nav class="max-w-6xl mx-auto flex items-center justify-between px-4 py-4">
      <a href="dashboard.html" class="flex items-center gap-3">
        <div class="h-10 w-10 rounded-2xl bg-gradient-to-br from-emerald-400 to-cyan-500 flex items-center justify-center text-slate-900 font-black text-lg">C</div>
        <span class="font-black text-xl bg-gradient-to-r from-emerald-400 to-cyan-400 bg-clip-text text-transparent">CodeRush</span>
      </a>
      <a href="dashboard.html" class="text-emerald-400 hover:text-emerald-300 font-semibold">‚Üê Back to Dashboard</a>
    </nav>
  </header>

  <main class="max-w-4xl mx-auto px-4 py-12">
    <div id="result-content" class="text-center">
      <!-- Loading state -->
      <div class="animate-pulse">
        <div class="w-24 h-24 bg-emerald-500/20 rounded-3xl mx-auto mb-8"></div>
        <h1 class="text-4xl font-black text-slate-400 mb-4">Calculating Results...</h1>
      </div>
    </div>
  </main>

  <script>
    const SUPABASE_URL = 'https://tghtgygjawhrcgtwhrej.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRnaHRneWdqYXdocmNndHdocmVqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5OTM0MjksImV4cCI6MjA4MTU2OTQyOX0.Q-Ht_IFcPZPIHO5905o70EDya2yFdVP-9LjDmjkle38';
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Get contest and user info from URL/localStorage
    const urlParams = new URLSearchParams(window.location.search);
    const contestId = urlParams.get('contest') || localStorage.getItem('currentContest');
    const userId = supabase.auth.getUser().then(({ data }) => data.user?.id);

    async function loadResult() {
      try {
        const { data: userData } = await supabase.auth.getUser();
        if (!userData.user) {
          window.location.href = 'index.html';
          return;
        }

        const { data: submissions } = await supabase
          .from('submissions')
          .select('*')
          .eq('user_id', userData.user.id)
          .eq('contest_id', contestId)
          .order('created_at', { ascending: false })
          .limit(10);

        if (!submissions || submissions.length === 0) {
          document.getElementById('result-content').innerHTML = `
            <div class="max-w-md mx-auto bg-slate-900/50 backdrop-blur-xl rounded-3xl p-12 border border-slate-800/50">
              <div class="w-24 h-24 bg-gradient-to-br from-slate-500/30 to-slate-400/30 rounded-3xl mx-auto mb-8 flex items-center justify-center">
                <svg class="w-12 h-12 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
              </div>
              <h1 class="text-3xl font-black text-slate-100 mb-4">No Submissions Found</h1>
              <p class="text-slate-400 mb-8">Complete the contest to see your results.</p>
              <a href="dashboard.html" class="px-8 py-4 bg-gradient-to-r from-emerald-500 to-emerald-400 text-slate-900 font-bold rounded-2xl shadow-xl hover:shadow-emerald-500/50 transition-all">‚Üê Back to Dashboard</a>
            </div>
          `;
          return;
        }

        // Calculate score (q1=100, q2=200, q3=300 marks)
        const score = submissions.reduce((total, sub) => {
          const marks = sub.question_id === 'q1' ? 100 : sub.question_id === 'q2' ? 200 : 300;
          return total + (sub.is_correct ? marks : 0);
        }, 0);

        // Show result
        document.getElementById('result-content').innerHTML = `
          <div class="max-w-2xl mx-auto bg-gradient-to-br from-emerald-500/10 to-cyan-500/10 backdrop-blur-xl rounded-3xl p-12 border border-emerald-500/30 shadow-2xl">
            <div class="w-32 h-32 bg-gradient-to-br from-emerald-400 to-cyan-500 rounded-3xl mx-auto mb-8 flex items-center justify-center shadow-2xl">
              <span class="text-5xl font-black text-slate-900">${score}</span>
            </div>
            <h1 class="text-4xl lg:text-5xl font-black bg-gradient-to-r from-slate-100 to-slate-200 bg-clip-text text-transparent mb-4">Your Score</h1>
            <p class="text-xl text-emerald-400 font-bold mb-12">${Math.round((score/600)*100)}% Accuracy</p>
            
            <div class="grid md:grid-cols-2 gap-6 mb-12">
              <div class="bg-slate-900/50 backdrop-blur-xl rounded-2xl p-6 border border-slate-800/50">
                <div class="text-3xl font-black text-emerald-400 mb-2">${submissions.length}</div>
                <div class="text-sm text-slate-400 uppercase tracking-wide">Questions Attempted</div>
              </div>
              <div class="bg-slate-900/50 backdrop-blur-xl rounded-2xl p-6 border border-slate-800/50">
                <div class="text-3xl font-black text-cyan-400 mb-2">${contestId === 'free' ? '‚úÖ Free' : 'üí∞ Paid'}</div>
                <div class="text-sm text-slate-400 uppercase tracking-wide">Contest Type</div>
              </div>
            </div>

            <div class="flex flex-col sm:flex-row gap-4">
              <a href="dashboard.html" class="flex-1 px-8 py-4 bg-gradient-to-r from-emerald-500 to-emerald-400 text-slate-900 font-bold rounded-2xl shadow-xl hover:shadow-emerald-500/50 transition-all text-center">Next Contest</a>
              <a href="#leaderboard" class="flex-1 px-8 py-4 border-2 border-emerald-400/50 text-emerald-400 font-bold rounded-2xl backdrop-blur-sm hover:bg-emerald-500/10 transition-all text-center" onclick="loadLeaderboard()">View Leaderboard</a>
            </div>
          </div>

          <!-- Leaderboard -->
          <div id="leaderboard-section" class="mt-20 hidden">
            <h2 class="text-3xl font-black text-center mb-12 bg-gradient-to-r from-slate-100 to-slate-300 bg-clip-text text-transparent">Leaderboard</h2>
            <div id="leaderboard-list" class="max-w-4xl mx-auto"></div>
          </div>
        `;

        localStorage.removeItem('currentContest');
      } catch (error) {
        console.error('Result load error:', error);
      }
    }

    async function loadLeaderboard() {
      try {
        const { data: leaderboard } = await supabase
          .from('submissions')
          .select('user_id, score:total_score')
          .eq('contest_id', contestId)
          .order('score', { ascending: false })
          .limit(50);

        document.getElementById('leaderboard-section').classList.remove('hidden');
        // Simple leaderboard render (basic)
        document.getElementById('leaderboard-list').innerHTML = `
          <div class="bg-slate-900/50 backdrop-blur-xl rounded-3xl p-8 border border-slate-800/50">
            <p class="text-center text-slate-400 text-lg mb-8">Top performers will appear here after contest ends</p>
            <div class="text-center text-emerald-400 font-bold text-xl">ü•á Calculating ranks...</div>
          </div>
        `;
      } catch (error) {
        console.error('Leaderboard error:', error);
      }
    }

    // Load result on page load
    window.addEventListener('load', loadResult);
  </script>
</body>
</html>
