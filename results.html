<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Contest Result – CodeRush</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * { font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
  </style>
</head>

<body class="min-h-screen text-slate-100 bg-slate-950
             bg-[radial-gradient(circle_at_top,_rgba(45,212,191,0.23),_transparent_52%),radial-gradient(circle_at_bottom,_rgba(37,99,235,0.22),_transparent_55%)]">

<main class="max-w-4xl mx-auto px-4 py-6 mt-6 mb-10 bg-slate-900/85 border border-slate-800/60 rounded-2xl shadow-[0_0_40px_rgba(15,23,42,0.95)]">
  <div id="result-header" class="flex items-center justify-between mb-4">
    <!-- JS se fill hoga -->
  </div>

  <section id="leaderboard" class="mt-4 text-xs">
    <!-- JS se fill hoga -->
  </section>
</main>

<!-- Supabase + Config -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="contests-config.js"></script>

<script>
  // === Supabase client: yahan apna URL + KEY daalo ===
  const SUPABASE_URL = 'https://YOUR_PROJECT_ID.supabase.co';
  const SUPABASE_ANON_KEY = 'YOUR_ANON_KEY';
  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // ---------- Helpers ----------
  function getContestIdFromUrl() {
    const params = new URLSearchParams(window.location.search);
    return params.get("contestId");
  }

  function findContestById(id) {
    return Array.isArray(CONTESTS) ? CONTESTS.find(c => c.id === id) : null;
  }

  // Fallback score (agar Supabase se kuch na mile)
  function getScoreFromUrlFallback() {
    const params = new URLSearchParams(window.location.search);
    return Number(params.get("score") || 0);
  }

  function getDummyLeaderboard(contestId, yourScore) {
    const leaderboard = [
      { rank: 1, name: "Rahul Sharma", score: 300, time: "25:32" },
      { rank: 2, name: "Priya K.", score: 280, time: "27:10" },
      { rank: 3, name: "Amit V", score: 260, time: "29:45" },
      { rank: 4, name: "Neha R", score: 240, time: "32:05" },
      { rank: 5, name: "You", score: yourScore, time: "35:12" }
    ];
    leaderboard.sort((a, b) => b.score - a.score);
    leaderboard.forEach((row, index) => { row.rank = index + 1; });
    return leaderboard;
  }

  function renderHeader(contest, yourScore) {
    const header = document.getElementById("result-header");
    if (!header) return;

    header.innerHTML = `
      <div>
        <p class="text-[11px] uppercase tracking-wide ${
          contest.type === "free" ? "text-emerald-400" : "text-amber-400"
        } mb-1">
          ${contest.type === "free" ? "Free contest" : "Paid contest"}
        </p>
        <h1 class="text-xl font-semibold mb-1">${contest.title} – Result</h1>
        <p class="text-slate-300 text-xs mb-1">
          Entry ${contest.entryFee === 0 ? "Free" : "₹" + contest.entryFee}
          • Total prize ₹${contest.totalPrize}
          • Top ${contest.maxWinners} students get rewards
        </p>
        <p class="text-emerald-400 text-sm font-semibold">
          Your score: <span id="your-score">${yourScore}</span> / 900
        </p>
      </div>

      <button onclick="window.location.href='dashboard.html'"
        class="px-3 py-1.5 rounded-lg bg-emerald-500 text-slate-900 text-[11px] font-semibold">
        Back to dashboard
      </button>
    `;
  }

  function renderLeaderboardRows(rows, yourUserId) {
    return rows.map((row, index) => {
      const isYou = row.user_id === yourUserId;
      return `
        <tr class="border-t border-slate-800 hover:bg-slate-800/60 ${isYou ? 'bg-emerald-500/20 border-emerald-400/50' : ''}">
          <td class="px-3 py-2 text-center font-semibold ${isYou ? 'text-emerald-400' : ''}">${index + 1}</td>
          <td class="px-3 py-2 font-semibold ${isYou ? 'text-emerald-400' : ''}">${isYou ? 'You' : (row.username || 'User')}</td>
          <td class="px-3 py-2 text-center font-semibold ${isYou ? 'text-emerald-400' : ''}">${row.score}</td>
          <td class="px-3 py-2 text-center">–</td>
        </tr>
      `;
    }).join("");
  }

  function renderLeaderboardFromDb(rows, yourUserId) {
    const lb = document.getElementById("leaderboard");
    if (!lb) return;

    const bodyRows = renderLeaderboardRows(rows, yourUserId);

    lb.innerHTML = `
      <h2 class="text-sm font-semibold mb-2">Leaderboard (Top 50)</h2>
      <div class="border border-slate-800 rounded-xl overflow-hidden">
        <table class="w-full text-[11px]">
          <thead class="bg-slate-800/80 text-slate-300">
            <tr>
              <th class="px-3 py-2 text-left">Rank</th>
              <th class="px-3 py-2 text-left">Student</th>
              <th class="px-3 py-2 text-left">Score</th>
              <th class="px-3 py-2 text-left">Time</th>
            </tr>
          </thead>
          <tbody class="text-slate-200">
            ${bodyRows}
          </tbody>
        </table>
      </div>
    `;
  }

  function renderLeaderboardDummy(contest, yourScore) {
    const lb = document.getElementById("leaderboard");
    if (!lb) return;

    const rows = getDummyLeaderboard(contest.id, yourScore)
      .map(row => {
        const isYou = row.name === "You";
        return `
          <tr class="border-t border-slate-800 hover:bg-slate-800/60 ${isYou ? 'bg-emerald-500/20 border-emerald-400/50' : ''}">
            <td class="px-3 py-2 text-center font-semibold ${isYou ? 'text-emerald-400' : ''}">${row.rank}</td>
            <td class="px-3 py-2 font-semibold ${isYou ? 'text-emerald-400' : ''}">${row.name}</td>
            <td class="px-3 py-2 text-center font-semibold ${isYou ? 'text-emerald-400' : ''}">${row.score}</td>
            <td class="px-3 py-2 text-center">${row.time}</td>
          </tr>
        `;
      })
      .join("");

    lb.innerHTML = `
      <h2 class="text-sm font-semibold mb-2">Leaderboard (Top 50)</h2>
      <div class="border border-slate-800 rounded-xl overflow-hidden">
        <table class="w-full text-[11px]">
          <thead class="bg-slate-800/80 text-slate-300">
            <tr>
              <th class="px-3 py-2 text-left">Rank</th>
              <th class="px-3 py-2 text-left">Student</th>
              <th class="px-3 py-2 text-left">Score</th>
              <th class="px-3 py-2 text-left">Time</th>
            </tr>
          </thead>
          <tbody class="text-slate-200">
            ${rows}
          </tbody>
        </table>
      </div>
    `;
  }

  // -------- REAL SCORE + LEADERBOARD (Supabase) --------
  async function calculateScoreAndSave() {
    const contestId = getContestIdFromUrl();
    const contest = findContestById(contestId);

    if (!contest) {
      document.body.innerHTML = `
        <div class="min-h-screen flex items-center justify-center bg-slate-950 text-slate-100">
          <div class="bg-slate-900 border border-slate-800 rounded-xl px-5 py-4 text-sm">
            <p class="text-red-400 font-semibold mb-2">Invalid contest.</p>
            <a href="dashboard.html" class="text-emerald-400 underline text-xs">Back to dashboard</a>
          </div>
        </div>
      `;
      return;
    }

    try {
      const { data: { user } } = await supabaseClient.auth.getUser();
      if (!user) {
        alert('Please login again.');
        window.location.href = 'index.html';
        return;
      }

      // 1) User submissions
      const { data: submissions } = await supabaseClient
        .from('submissions')
        .select('question_id, code')
        .eq('user_id', user.id)
        .eq('contest_id', contestId);

      // 2) Problems with marks
      const { data: problems } = await supabaseClient
        .from('problems')
        .select('id, marks');

      // 3) Calculate total score
      let totalScore = 0;
      if (submissions && problems) {
        submissions.forEach(sub => {
          const p = problems.find(pr => pr.id === sub.question_id);
          if (p && sub.code && sub.code.trim().length > 0) {
            totalScore += p.marks;
          }
        });
      }

      const fallbackScore = getScoreFromUrlFallback();
      const finalScore = totalScore || fallbackScore;

      // 4) Header render
      renderHeader(contest, finalScore);

      // 5) Save to leaderboard
      await supabaseClient
        .from('leaderboard')
        .upsert({
          contest_id: contestId,
          user_id: user.id,
          score: finalScore
        });

      await supabaseClient.rpc('update_leaderboard_ranks', { target_contest_id: contestId });

      // 6) Fetch top 50 leaderboard
      const { data: lbRows } = await supabaseClient
        .from('leaderboard')
        .select('user_id, score')
        .eq('contest_id', contestId)
        .order('score', { ascending: false })
        .limit(50);

      if (lbRows && lbRows.length) {
        renderLeaderboardFromDb(lbRows, user.id);
      } else {
        renderLeaderboardDummy(contest, finalScore);
      }

    } catch (err) {
      console.error('Result error', err);
      const fallback = getScoreFromUrlFallback();
      renderHeader(contest || { title: 'Contest', type: 'free', entryFee: 0, totalPrize: 0, maxWinners: 0 }, fallback);
      renderLeaderboardDummy(contest || { id: 'unknown' }, fallback);
    }
  }

  document.addEventListener("DOMContentLoaded", calculateScoreAndSave);
</script>

</body>
</html>
