<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Contest Result ‚Äì CodeRush</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
  </style>
</head>

<body class="min-h-screen text-slate-100 bg-slate-950
             bg-[radial-gradient(circle_at_top,_rgba(45,212,191,0.23),_transparent_52%),radial-gradient(circle_at_bottom,_rgba(37,99,235,0.22),_transparent_55%)]">

<main class="max-w-4xl mx-auto px-4 py-6 mt-6 mb-10 bg-slate-900/85 border border-slate-800/60 rounded-2xl shadow-[0_0_40px_rgba(15,23,42,0.95)]">
  <!-- Header -->
  <div id="result-header" class="flex items-center justify-between mb-4">
    <!-- JS se fill hoga -->
  </div>

  <!-- Overall score card -->
  <section id="score-card" class="mb-5">
    <div class="bg-slate-800/80 border border-slate-700 rounded-2xl px-4 py-3 flex items-center justify-between">
      <div>
        <p class="text-[11px] text-slate-400">Overall score</p>
        <p id="overall-score" class="text-xl font-semibold text-emerald-400">Calculating...</p>
      </div>
      <div class="flex gap-2">
        <button onclick="window.location.href='dashboard.html'"
          class="px-3 py-1.5 rounded-lg bg-emerald-500 text-slate-900 text-[11px] font-semibold">
          Dashboard
        </button>
        <button onclick="window.print()"
          class="px-3 py-1.5 rounded-lg bg-slate-700 text-slate-100 text-[11px] font-semibold hover:bg-slate-600">
          üìÑ Share
        </button>
      </div>
    </div>
  </section>

  <!-- Per-question breakdown -->
  <section class="mb-5">
    <h2 class="text-sm font-semibold mb-2">Question wise breakdown</h2>
    <div id="breakdown-body" class="border border-slate-800 rounded-xl overflow-hidden text-xs">
      <div class="px-3 py-2 text-[11px] text-slate-400">Loading breakdown...</div>
    </div>
  </section>

  <!-- Leaderboard (Top 50 of this contest) -->
  <section id="leaderboard" class="mt-4 text-xs">
    <h2 class="text-sm font-semibold mb-2">Contest leaderboard (Top 50)</h2>
    <div id="leaderboard-body" class="border border-slate-800 rounded-xl overflow-hidden">
      <div class="px-3 py-2 text-[11px] text-slate-400">Loading leaderboard...</div>
    </div>
  </section>

  <!-- Quick stats -->
  <section class="mt-6 pt-6 border-t border-slate-800/60">
    <h3 class="text-sm font-semibold mb-3 text-emerald-400">Your Stats</h3>
    <div class="grid grid-cols-3 gap-4 text-xs">
      <div class="bg-slate-800/50 rounded-xl p-3 text-center">
        <div class="text-2xl font-bold text-emerald-400" id="accuracy">-</div>
        <div class="text-slate-400">Accuracy</div>
      </div>
      <div class="bg-slate-800/50 rounded-xl p-3 text-center">
        <div class="text-2xl font-bold text-emerald-400" id="total-attempts">-</div>
        <div class="text-slate-400">Questions Attempted</div>
      </div>
      <div class="bg-slate-800/50 rounded-xl p-3 text-center">
        <div class="text-2xl font-bold text-blue-400" id="percentile">-</div>
        <div class="text-slate-400">Percentile</div>
      </div>
    </div>
  </section>
</main>

<script src="contests-config.js"></script>
<script>
  // === Supabase client ===
  const SUPABASE_URL = 'https://tghtgygjawhrcgtwhrej.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRnaHRneWdqYXdocmNndHdocmVqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5OTM0MjksImV4cCI6MjA4MTU2OTQyOX0.Q-Ht_IFcPZPIHO5905o70EDya2yFdVP-9LjDmjkle38';
  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // Helpers
  function getContestIdFromUrl() {
    const params = new URLSearchParams(window.location.search);
    return params.get("contestId") || localStorage.getItem('currentContestId') || 'free-200';
  }

  function findContestById(id) {
    return Array.isArray(CONTESTS) ? CONTESTS.find(c => c.id === id) : null;
  }

  function getScoreFromLocalStorage() {
    try {
      const submissions = JSON.parse(localStorage.getItem('examSubmissions') || '[]');
      return submissions.filter(s => s.answered).length;
    } catch {
      return 0;
    }
  }

  function renderHeader(contest, yourScore, maxMarks) {
    const header = document.getElementById("result-header");
    if (!header || !contest) return;

    header.innerHTML = `
      <div>
        <p class="text-[11px] uppercase tracking-wide ${
          contest.type === "free" ? "text-emerald-400" : "text-amber-400"
        } mb-1">
          ${contest.type === "free" ? "Free contest" : "Paid contest"}
        </p>
        <h1 class="text-xl font-semibold mb-1">${contest.title} ‚Äì Result</h1>
        <p class="text-slate-300 text-xs mb-1">
          Entry ${contest.entryFee === 0 ? "Free" : "‚Çπ" + contest.entryFee}
          ‚Ä¢ Total prize ‚Çπ${contest.totalPrize}
          ‚Ä¢ Top ${contest.maxWinners} students get rewards
        </p>
        <p class="text-emerald-400 text-sm font-semibold">
          Your score: <span id="your-score">${yourScore}</span> / ${maxMarks}
        </p>
      </div>
    `;
  }

  // Main flow: calculate score, show breakdown, save to leaderboard
  async function loadResultPage() {
    const contestId = getContestIdFromUrl();
    const contest = findContestById(contestId);

    if (!contest) {
      document.body.innerHTML = `
        <div class="min-h-screen flex items-center justify-center bg-slate-950 text-slate-100">
          <div class="bg-slate-900 border border-slate-800 rounded-xl px-5 py-4 text-sm">
            <p class="text-red-400 font-semibold mb-2">Invalid contest.</p>
            <a href="dashboard.html" class="text-emerald-400 underline text-xs">Back to dashboard</a>
          </div>
        </div>
      `;
      return;
    }

    try {
      const { data: { user } } = await supabaseClient.auth.getUser();
      if (!user) {
        alert('Please login again.');
        window.location.href = 'index.html';
        return;
      }

      // 1) Get submissions from Supabase + localStorage fallback
      const { data: submissions } = await supabaseClient
        .from('submissions')
        .select('question_id, code, answered')
        .eq('user_id', user.id)
        .eq('contest_id', contestId)
        .order('question_id');

      // 2) Problems with marks
      const { data: problems } = await supabaseClient
        .from('problems')
        .select('id, title, marks, correct_answer')
        .eq('contest_id', contestId);

      // 3) Calculate total score + breakdown rows
      let totalScore = 0;
      const breakdownRows = [];
      const attemptedCount = submissions?.length || 0;

      const problemMap = {};
      if (problems) {
        problems.forEach(p => { problemMap[p.id] = p; });
      }

      const questionIds = ['q1', 'q2', 'q3'];
      questionIds.forEach((qid, index) => {
        const p = problemMap[qid] || { title: `Question ${index + 1}`, marks: 100 };
        const sub = submissions?.find(s => s.question_id === qid);
        
        const attempted = sub && (sub.code?.trim().length > 0 || sub.answered);
        const gained = attempted ? (p.marks || 100) : 0;

        totalScore += gained;

        breakdownRows.push({
          id: qid,
          title: p.title || `Question ${index + 1}`,
          marks: p.marks || 100,
          attempted,
          gained
        });
      });

      const maxMarks = 600; // q1=100 + q2=200 + q3=300
      const finalScore = totalScore;
      const accuracy = attemptedCount > 0 ? Math.round((totalScore / maxMarks) * 100) : 0;

      // 4) Render header + overall score
      renderHeader(contest, finalScore, maxMarks);
      document.getElementById('overall-score').textContent = `${finalScore} / ${maxMarks}`;

      // 5) Render breakdown table
      renderBreakdownTable(breakdownRows);

      // 6) Update stats
      document.getElementById('accuracy').textContent = `${accuracy}%`;
      document.getElementById('total-attempts').textContent = attemptedCount;

      // 7) Save to leaderboard + show leaderboard
      await saveToLeaderboardAndShow(user.id, contestId, finalScore, accuracy);

      // Clear exam data
      localStorage.removeItem('examSubmissions');
      localStorage.removeItem('currentContestId');

    } catch (err) {
      console.error('Result error', err);
      document.getElementById('overall-score').textContent = 'Error';
      document.getElementById('breakdown-body').innerHTML =
        `<div class="px-3 py-2 text-[11px] text-red-400">Error loading result. Try refreshing.</div>`;
    }
  }

  function renderBreakdownTable(rows) {
    const body = document.getElementById('breakdown-body');
    if (!body) return;

    if (!rows || rows.length === 0) {
      body.innerHTML = `<div class="px-3 py-2 text-[11px] text-slate-400">No submissions found.</div>`;
      return;
    }

    const htmlRows = rows.map((row, index) => `
      <tr class="border-t border-slate-800 hover:bg-slate-800/30">
        <td class="px-3 py-2 text-[11px] text-slate-200 font-mono">#${index + 1}</td>
        <td class="px-3 py-2 text-[11px] text-slate-200">${row.title}</td>
        <td class="px-3 py-2 text-[11px] text-center text-slate-100 font-semibold">${row.marks}</td>
        <td class="px-3 py-2 text-[11px] text-center ${row.attempted ? 'text-emerald-400 font-semibold' : 'text-slate-400'}">
          ${row.attempted ? '‚úÖ Attempted' : '‚ùå Skipped'}
        </td>
        <td class="px-3 py-2 text-[11px] text-center ${row.attempted ? 'text-emerald-400 font-bold text-lg' : 'text-slate-400'}">
          ${row.gained}
        </td>
      </tr>
    `).join('');

    body.innerHTML = `
      <table class="w-full text-[11px]">
        <thead class="bg-slate-800/80 text-slate-300 sticky top-0">
          <tr>
            <th class="px-3 py-2 text-left">Q#</th>
            <th class="px-3 py-2 text-left">Question</th>
            <th class="px-3 py-2 text-left">Marks</th>
            <th class="px-3 py-2 text-left">Status</th>
            <th class="px-3 py-2 text-left">Gained</th>
          </tr>
        </thead>
        <tbody class="text-slate-200">
          ${htmlRows}
        </tbody>
      </table>
    `;
  }

  async function saveToLeaderboardAndShow(userId, contestId, score, accuracy) {
    // Save / update score
    const { error: upsertError } = await supabaseClient
      .from('leaderboard')
      .upsert({ 
        contest_id: contestId, 
        user_id: userId, 
        score: score,
        accuracy: accuracy
      });

    if (upsertError) {
      console.error('Leaderboard save error:', upsertError);
    }

    // Fetch top 50 + your rank
    const container = document.getElementById('leaderboard-body');
    try {
      const { data: leaderboard, error } = await supabaseClient
        .from('leaderboard')
        .select('user_id, score, rank, accuracy')
        .eq('contest_id', contestId)
        .order('score', { ascending: false })
        .limit(50);

      if (error) {
        console.error('Leaderboard fetch error:', error);
        container.innerHTML = `<div class="px-3 py-2 text-[11px] text-red-400">Failed to load leaderboard.</div>`;
        return;
      }

      if (!leaderboard || leaderboard.length === 0) {
        container.innerHTML = `<div class="px-3 py-2 text-[11px] text-slate-400">No participants yet. You're first! üéâ</div>`;
        return;
      }

      // Calculate your percentile
      const yourScore = leaderboard.find(l => l.user_id === userId)?.score || 0;
      const betterThanYou = leaderboard.filter(l => l.score > yourScore).length;
      const percentile = Math.max(0, 100 - Math.round((betterThanYou / leaderboard.length) * 100));
      document.getElementById('percentile').textContent = `${percentile}%`;

      const { data: { user } } = await supabaseClient.auth.getUser();
      const rowsHtml = leaderboard.map((row, index) => {
        const isYou = user && row.user_id === user.id;
        const rank = row.rank || (index + 1);

        let displayName = isYou ? 'üë§ You' : `User ${row.user_id.slice(-6)}`;

        return `
          <tr class="border-t border-slate-800 ${isYou ? 'bg-emerald-500/20 border-emerald-400/50' : 'hover:bg-slate-800/60'}">
            <td class="px-3 py-1.5 text-center text-[11px] font-bold ${isYou ? 'text-emerald-400 text-sm' : ''}">
              #${rank}
            </td>
            <td class="px-3 py-1.5 text-[11px] font-medium ${isYou ? 'text-emerald-400' : ''}">
              ${displayName}
            </td>
            <td class="px-3 py-1.5 text-center text-[11px] font-bold ${isYou ? 'text-emerald-400 text-sm' : ''}">
              ${row.score}
            </td>
          </tr>
        `;
      }).join('');

      container.innerHTML = `
        <table class="w-full text-[11px]">
          <thead class="bg-slate-800/80 text-slate-300">
            <tr>
              <th class="px-3 py-1.5 text-left w-12">Rank</th>
              <th class="px-3 py-1.5 text-left">Student</th>
              <th class="px-3 py-1.5 text-left w-20">Score</th>
            </tr>
          </thead>
          <tbody class="text-slate-200">
            ${rowsHtml}
          </tbody>
        </table>
      `;
    } catch (e) {
      console.error('Leaderboard render error:', e);
      container.innerHTML = `<div class="px-3 py-2 text-[11px] text-red-400">Error loading leaderboard.</div>`;
    }
  }

  // Auto-redirect from exam.html after time ends
  if (window.location.search.includes('from=exam')) {
    document.title = 'Result - CodeRush';
  }

  document.addEventListener("DOMContentLoaded", loadResultPage);
</script>

</body>
</html>
