<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CodeRush ‚Äì Contest Results</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Supabase core + common client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="supabase-client.js"></script>
  <style>
    * { font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
    .code-snippet { font-family: 'JetBrains Mono', monospace; font-size: 12px; }
  </style>
</head>

<body class="min-h-screen text-slate-100 bg-slate-950
             bg-[radial-gradient(circle_at_top,_rgba(45,212,191,0.23),_transparent_52%),radial-gradient(circle_at_bottom,_rgba(37,99,235,0.22),_transparent_55%)]">

<!-- Top Navbar -->
<header class="border-b border-slate-800/60 bg-slate-950/80 backdrop-blur sticky top-0 z-30">
  <nav class="max-w-6xl mx-auto flex items-center justify-between px-4 py-3">
    <div class="flex items-center gap-2">
      <div class="h-8 w-8 rounded-xl bg-gradient-to-br from-emerald-400 to-cyan-500 flex items-center justify-center text-slate-900 font-extrabold">
        C
      </div>
      <span class="font-semibold text-lg tracking-tight">CodeRush</span>
    </div>
    <div class="flex items-center gap-3 text-xs">
      <span id="user-email-results" class="hidden sm:inline text-slate-300"></span>
      <a href="dashboard.html" class="px-3 py-1.5 rounded-lg border border-slate-700 hover:border-emerald-400 hover:text-emerald-300">
        ‚Üê Back to Dashboard
      </a>
    </div>
  </nav>
</header>

<main class="max-w-6xl mx-auto px-4 py-8">
  <!-- Contest header -->
  <section class="bg-slate-900/80 border border-slate-800 rounded-2xl p-6 mb-6 text-center">
    <div class="flex flex-col md:flex-row items-center gap-4 md:justify-between mb-4">
      <div class="flex items-center gap-3">
        <div class="h-12 w-12 rounded-2xl bg-gradient-to-br from-emerald-400 to-cyan-500 flex items-center justify-center text-slate-900 font-bold text-lg">
          C
        </div>
        <div>
          <h1 id="contest-title-results" class="text-xl md:text-2xl font-bold">Free Daily Rush #47</h1>
          <p id="contest-date" class="text-sm text-slate-400">Dec 25, 2025 ‚Ä¢ 60 minutes</p>
        </div>
      </div>
      <div class="flex items-center gap-4 text-sm">
        <div class="text-center">
          <div id="final-score" class="text-3xl font-bold text-emerald-400">52</div>
          <div class="text-xs text-slate-400">Final Score</div>
        </div>
        <div class="text-center">
          <div id="final-rank" class="text-3xl font-bold text-amber-400">#3</div>
          <div class="text-xs text-slate-400">of 127</div>
        </div>
        <div class="text-center">
          <div class="text-3xl font-bold text-emerald-400">3/3</div>
          <div class="text-xs text-slate-400">Solved</div>
        </div>
      </div>
    </div>

    <!-- Prize info -->
    <div class="grid md:grid-cols-3 gap-4 mt-6">
      <div class="bg-emerald-500/20 border border-emerald-500/40 rounded-xl p-4">
        <h3 class="font-semibold text-sm mb-1">üèÜ 1st Prize</h3>
        <div class="text-lg font-bold text-emerald-400">‚Çπ500</div>
      </div>
      <div class="bg-amber-500/20 border border-amber-500/40 rounded-xl p-4">
        <h3 class="font-semibold text-sm mb-1">ü•à 2nd Prize</h3>
        <div class="text-lg font-bold text-amber-400">‚Çπ250</div>
      </div>
      <div class="bg-slate-700/50 border border-slate-700 rounded-xl p-4">
        <h3 class="font-semibold text-sm mb-1">ü•â 3rd Prize</h3>
        <div class="text-lg font-bold text-slate-300">‚Çπ100</div>
      </div>
    </div>
  </section>

  <div class="grid lg:grid-cols-2 gap-6">
    <!-- Left: Problem-wise results -->
    <section>
      <h2 class="text-lg font-bold mb-4">Problem-wise breakdown</h2>
      <div id="problem-results-list" class="space-y-3"></div>
    </section>

    <!-- Right: Full leaderboard -->
    <section>
      <h2 class="text-lg font-bold mb-4 flex items-center justify-between">
        Full Leaderboard
        <span id="total-participants" class="text-sm text-slate-400">127 participants</span>
      </h2>
      <div id="full-leaderboard" class="bg-slate-900/80 border border-slate-800 rounded-2xl overflow-hidden">
        <div class="animate-pulse py-8">
          <div class="h-4 bg-slate-700 rounded mx-4 mb-2"></div>
        </div>
      </div>
    </section>
  </div>

  <!-- Action buttons -->
  <div class="flex flex-col sm:flex-row gap-3 mt-8 pt-6 border-t border-slate-800">
    <button id="share-results" class="flex-1 bg-gradient-to-r from-emerald-500 to-cyan-500 text-slate-900 py-3 rounded-xl font-semibold text-center hover:from-emerald-400 hover:to-cyan-400">
      üì± Share Results
    </button>
    <a href="exam.html?type=free" class="flex-1 border border-emerald-400 text-emerald-400 py-3 rounded-xl font-semibold text-center hover:bg-emerald-500/20">
      Play Next Contest
    </a>
  </div>
</div>

<script>
  const supabaseClient = window.supabaseClient;
  let contestId = null;
  let userResults = null;

  // ===== Auth + Init =====
  document.addEventListener('DOMContentLoaded', async () => {
    const user = await window.requireAuth();
    if (!user) return;
    
    document.getElementById('user-email-results').textContent = user.email;
    
    // Get contest ID from URL or latest contest
    const urlParams = new URLSearchParams(window.location.search);
    contestId = urlParams.get('contest') || 'daily-rush-251225';
    
    await loadResults(contestId);
  });

  // ===== Load results =====
  async function loadResults(contestId) {
    try {
      const user = await window.getCurrentUser();
      
      // Get user results
      const { data: userData } = await supabaseClient
        .from('leaderboard')
        .select('*, submissions(score, problem_num, status)')
        .eq('user_id', user.id)
        .eq('contest_id', contestId)
        .single();

      // Get contest info (dummy for now)
      const contestInfo = {
        title: 'Free Daily Rush #47',
        date: 'Dec 25, 2025',
        totalParticipants: 127
      };

      // Update header
      document.getElementById('contest-title-results').textContent = contestInfo.title;
      document.getElementById('contest-date').textContent = contestInfo.date;
      document.getElementById('total-participants').textContent = `${contestInfo.totalParticipants} participants`;
      
      // Update scores (dummy data for demo)
      document.getElementById('final-score').textContent = '52';
      document.getElementById('final-rank').textContent = '#3';

      userResults = userData;
      await loadProblemResults();
      await loadFullLeaderboard(contestId);
      
    } catch (error) {
      console.error('Results load error:', error);
      document.getElementById('problem-results-list').innerHTML = 
        '<p class="text-slate-400 text-sm">No results found. Complete a contest first.</p>';
    }
  }

  // ===== Problem results =====
  async function loadProblemResults() {
    const container = document.getElementById('problem-results-list');
    
    // Demo problem results
    const demoProblems = [
      {
        num: 1,
        title: 'Two Sum',
        score: 20,
        status: '‚úÖ Accepted',
        time: '2:34',
        attempts: 1
      },
      {
        num: 2,
        title: 'Valid Parentheses',
        score: 20,
        status: '‚úÖ Accepted',
        time: '5:12',
        attempts: 2
      },
      {
        num: 3,
        title: 'Longest Common Prefix',
        score: 12,
        status: '‚ùå Partial (TLE)',
        time: '8:45',
        attempts: 3
      }
    ];

    const html = demoProblems.map(problem => `
      <div class="bg-slate-900/80 border border-slate-800 rounded-xl p-4 hover:border-emerald-500/50 transition-all">
        <div class="flex items-center justify-between mb-2">
          <h3 class="font-semibold text-sm">${problem.title}</h3>
          <span class="px-2 py-1 rounded-full text-[11px] bg-emerald-500/20 text-emerald-400">
            ${problem.score}/20
          </span>
        </div>
        <div class="flex items-center gap-4 text-xs text-slate-400 mb-2">
          <span>${problem.status}</span>
          <span>‚Ä¢ ${problem.time}</span>
          <span>‚Ä¢ ${problem.attempts} attempts</span>
        </div>
        <div class="code-snippet bg-slate-800/50 p-2 rounded-lg text-emerald-400 text-[11px] overflow-x-auto">
          function ${problem.title.toLowerCase().replace(/\s+/g, '')}(...) { ... }
        </div>
      </div>
    `).join('');

    container.innerHTML = html;
  }

  // ===== Full leaderboard =====
  async function loadFullLeaderboard(contestId) {
    const container = document.getElementById('full-leaderboard');
    
    try {
      const { data } = await supabaseClient
        .from('leaderboard')
        .select('user_id, score, rank')
        .eq('contest_id', contestId)
        .order('score', { ascending: false })
        .limit(50);

      if (!data || data.length === 0) {
        container.innerHTML = '<p class="text-center py-8 text-slate-400 text-sm">No results yet</p>';
        return;
      }

      const user = await window.getCurrentUser();
      const rows = data.map((row, index) => {
        const isYou = row.user_id === user.id;
        const displayRank = row.rank || index + 1;
        const displayName = row.user_id.slice(0, 8) + '...';
        
        return `
          <div class="flex items-center px-4 py-3 border-t border-slate-800 last:border-b 
                      ${isYou ? 'bg-emerald-500/10 border-emerald-500/30' : 'hover:bg-slate-800/50'}">
            <div class="w-12 text-center font-bold ${isYou ? 'text-emerald-400' : 'text-slate-300'}">
              ${displayRank}
            </div>
            <div class="flex-1 font-mono text-sm truncate ${isYou ? 'text-emerald-400 font-semibold' : ''}">
              ${displayName}
            </div>
            <div class="w-20 text-right font-mono font-bold text-emerald-400">
              ${row.score}
            </div>
          </div>
        `;
      }).join('');

      container.innerHTML = `
        <div class="divide-y divide-slate-800">
          ${rows}
        </div>
      `;
    } catch (error) {
      console.error('Leaderboard error:', error);
      container.innerHTML = '<p class="text-center py-8 text-red-400 text-sm">Failed to load leaderboard</p>';
    }
  }

  // ===== Share button =====
  document.getElementById('share-results').onclick = () => {
    if (navigator.share) {
      navigator.share({
        title: 'CodeRush Contest Results',
        text: 'Check out my contest results on CodeRush!',
        url: window.location.href
      });
    } else {
      // Fallback: copy URL
      navigator.clipboard.writeText(window.location.href);
      alert('Results link copied! Share it anywhere.');
    }
  };
</script>

</body>
</html>
