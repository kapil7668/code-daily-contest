<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PAID-9 Contest - CodeRush</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>* { font-family: system-ui, sans-serif; }</style>
</head>
<body class="min-h-screen text-slate-100 bg-slate-950 bg-[radial-gradient(circle_at_top,_rgba(45,212,191,0.23),_transparent_52%),radial-gradient(circle_at_bottom,_rgba(37,99,235,0.22),_transparent_55%)]">

<main class="max-w-6xl mx-auto px-4 py-5 md:py-7 mt-6 mb-10 bg-slate-900/80 border border-slate-800/60 rounded-2xl shadow-[0_0_40px_rgba(15,23,42,0.95)]">
  <header class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
    <div>
      <p class="text-[11px] uppercase tracking-wide text-amber-400 mb-1">PAID ‚Çπ9</p>
      <h1 class="text-lg md:text-xl font-semibold mb-1">PAID-9 Contest</h1>
      <p class="text-[11px] text-slate-400">5 Questions ‚Ä¢ 60 Min ‚Ä¢ ‚Çπ900 Prize</p>
    </div>
    <div class="flex items-center gap-4">
      <div class="text-right">
        <p class="text-[11px] text-slate-400">Time remaining</p>
        <p id="timer" class="text-xl font-semibold text-emerald-400">60:00</p>
      </div>
      <div class="flex items-center gap-2">
        <button id="saveProgressBtn" class="px-4 py-2 rounded-lg bg-blue-600/80 hover:bg-blue-600 text-white text-sm font-semibold shadow-lg transition-all">
          üíæ Save Progress
        </button>
        <button id="finalSubmitBtn" class="px-6 py-2 rounded-lg bg-gradient-to-r from-emerald-500 to-emerald-600 text-white text-sm font-bold hover:from-emerald-600 hover:to-emerald-700 shadow-lg flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
          <span id="submitText">‚úÖ Submit & View Result</span>
          <div id="submitSpinner" class="hidden animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
        </button>
      </div>
    </div>
  </header>

  <section class="grid md:grid-cols-[220px,1fr] gap-4 mt-4">
    <aside class="bg-slate-900/80 border border-slate-800 rounded-2xl p-3 text-xs">
      <h2 class="text-[12px] font-semibold mb-2">Questions (<span id="question-count">0</span>)</h2>
      <div id="questions-list" class="space-y-1 max-h-96 overflow-y-auto"></div>
    </aside>

    <section class="bg-slate-900/80 border border-slate-800 rounded-2xl p-3 text-xs flex flex-col">
      <div class="mb-2 flex items-center justify-between">
        <div>
          <p id="question-label" class="text-[11px] text-slate-400 mb-0.5">Question 1</p>
          <h2 id="question-title" class="text-sm font-semibold">Loading...</h2>
        </div>
        <div id="question-tags" class="text-[11px] text-right text-slate-400"></div>
      </div>

      <div id="question-statement" class="text-[12px] text-slate-200 mb-3 min-h-[120px] p-4 bg-slate-800/50 rounded-lg">Loading question...</div>

      <div id="mcq-options" class="space-y-2 mb-4 hidden">
        <label class="flex items-center p-3 bg-slate-800/50 rounded-lg border-2 border-slate-700 cursor-pointer hover:border-emerald-500 hover:bg-emerald-500/10">
          <input type="radio" name="mcq-answer" value="0" class="w-4 h-4 text-emerald-500 ml-3">
          <span id="mcq-opt-0" class="ml-3 text-sm"></span>
        </label>
        <label class="flex items-center p-3 bg-slate-800/50 rounded-lg border-2 border-slate-700 cursor-pointer hover:border-emerald-500 hover:bg-emerald-500/10">
          <input type="radio" name="mcq-answer" value="1" class="w-4 h-4 text-emerald-500 ml-3">
          <span id="mcq-opt-1" class="ml-3 text-sm"></span>
        </label>
        <label class="flex items-center p-3 bg-slate-800/50 rounded-lg border-2 border-slate-700 cursor-pointer hover:border-emerald-500 hover:bg-emerald-500/10">
          <input type="radio" name="mcq-answer" value="2" class="w-4 h-4 text-emerald-500 ml-3">
          <span id="mcq-opt-2" class="ml-3 text-sm"></span>
        </label>
        <label class="flex items-center p-3 bg-slate-800/50 rounded-lg border-2 border-slate-700 cursor-pointer hover:border-emerald-500 hover:bg-emerald-500/10">
          <input type="radio" name="mcq-answer" value="3" class="w-4 h-4 text-emerald-500 ml-3">
          <span id="mcq-opt-3" class="ml-3 text-sm"></span>
        </label>
      </div>

      <label class="text-[11px] text-slate-300 mb-1 block">Your answer</label>
      <textarea id="answer-input" class="flex-1 min-h-[180px] w-full bg-slate-950/70 border border-slate-800 rounded-xl px-3 py-2 text-[12px] text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-500 resize-vertical" placeholder="Type your solution here..."></textarea>

      <div class="mt-4 flex items-center justify-between">
        <div class="flex items-center gap-2">
          <button id="save-answer-btn" class="px-4 py-2 rounded-lg border-2 border-emerald-500 text-emerald-300 text-sm font-semibold hover:bg-emerald-500/20">üíæ Save</button>
          <button id="run-debug-btn" class="px-4 py-2 rounded-lg border border-slate-600 text-slate-200 text-sm hover:bg-slate-800">‚ñ∂Ô∏è Run</button>
        </div>
        <div class="flex gap-2">
          <button id="prev-btn" class="px-4 py-2 rounded-lg border border-slate-700 text-sm text-slate-200 hover:bg-slate-800 disabled:opacity-50">‚Üê Prev</button>
          <button id="next-btn" class="px-4 py-2 rounded-lg bg-emerald-500 text-slate-900 text-sm font-semibold hover:bg-emerald-600">Next ‚Üí</button>
        </div>
      </div>
    </section>
  </section>
</main>

<script>
  // ‚úÖ GLOBAL SUPABASE CLIENT - FIRST LOAD
  const SUPABASE_URL = 'https://tghtgygjawhrcgtwhrej.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRnaHRneWdqYXdocmNndHdocmVqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5OTM0MjksImV4cCI6MjA4MTU2OTQyOX0.Q-Ht_IFcPZPIHO5905o70EDya2yFdVP-9LjDmjkle38';
  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // ‚úÖ GLOBAL QUESTIONS ARRAY
  const questions = [
    {"question": "What is 2+2?", "statement": "Basic arithmetic question", "options": ["3", "4", "5", "6"], "answer": 1, "type": "mcq", "marks": 20},
    {"question": "Array length kaise nikale?", "statement": "JavaScript array length property", "options": [".size()", ".length", ".count", ".size"], "answer": 1, "type": "mcq", "marks": 20},
    {"question": "console.log ka output?", "statement": "Browser console method", "options": ["Print", "Log", "Display", "Show"], "answer": 1, "type": "mcq", "marks": 20},
    {"question": "var vs let?", "statement": "JavaScript variable declaration", "options": ["Same", "let is block scoped", "var is faster", "No difference"], "answer": 1, "type": "mcq", "marks": 20},
    {"question": "Coding Problem 1", "statement": "Write function to reverse string: def reverse(s):", "type": "coding", "marks": 20}
  ];

  let currentIndex = 0, timerInterval, examLocked = false, mcqAnswers = {};

  // ‚úÖ PERFECT saveAllSubmissions FUNCTION
  async function saveAllSubmissions() {
    try {
      const { data: { user } } = await supabaseClient.auth.getUser();
      if (!user) throw new Error('No user logged in');

      const contestId = 'paid-9';
      const submissions = questions.map((q, i) => ({
        user_id: user.id,
        contest_id: contestId,
        question_id: `q${i+1}`,
        code: localStorage.getItem(`paid9_${i}`) || '',
        answered: mcqAnswers[i] !== undefined || (localStorage.getItem(`paid9_${i}`) && localStorage.getItem(`paid9_${i}`).trim().length > 0),
        marks: q.marks || 20,
        language: 'javascript'
      }));

      const { data, error } = await supabaseClient
        .from('submissions')
        .upsert(submissions, { 
          onConflict: 'user_id,contest_id,question_id',
          ignoreDuplicates: false 
        });

      if (error) {
        console.error('Supabase error:', error);
        throw new Error(error.message);
      }
      
      console.log('‚úÖ Saved to Supabase:', data.length, 'submissions');
      return data;
      
    } catch (error) {
      console.error('Save failed:', error);
      throw error;
    }
  }

  function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `fixed top-4 right-4 z-50 p-4 rounded-xl shadow-2xl text-sm font-semibold transform translate-x-full transition-all duration-300 ${
      type === 'success' ? 'bg-emerald-500 text-white' : type === 'warning' ? 'bg-amber-500 text-white' : 'bg-red-500 text-white'
    }`;
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.classList.remove('translate-x-full'), 100);
    setTimeout(() => {
      toast.classList.add('translate-x-full');
      setTimeout(() => toast.remove(), 300);
    }, 3000);
  }

  // All other functions (renderQuestionsList, renderCurrentQuestion, etc.) - SAME AS BEFORE
  function renderQuestionsList() {
    document.getElementById('questions-list').innerHTML = questions.map((q, i) => {
      const isAnswered = mcqAnswers[i] !== undefined || localStorage.getItem(`paid9_${i}`);
      return `<button class="w-full text-left p-2 rounded-lg border text-xs mb-1 ${i===currentIndex ? 'bg-emerald-500/30 border-emerald-500' : (isAnswered ? 'bg-blue-500/20 border-blue-500' : 'border-slate-700 bg-slate-900/50')} hover:bg-emerald-500/20" onclick="gotoQuestion(${i})">
        Q${i+1} ${q.type==='coding'?'üíª':'‚ùì'} ${isAnswered?'‚úÖ':''}
      </button>`;
    }).join('');
    document.getElementById('question-count').textContent = questions.filter((q,i) => mcqAnswers[i] !== undefined || localStorage.getItem(`paid9_${i}`)).length;
  }

  function renderCurrentQuestion() {
    const q = questions[currentIndex];
    document.getElementById('question-label').textContent = `Question ${currentIndex+1}/${questions.length}`;
    document.getElementById('question-title').textContent = q.question;
    document.getElementById('question-statement').textContent = q.statement;
    document.getElementById('question-tags').textContent = `${q.type?.toUpperCase()||'MCQ'} (${q.marks} marks)`;

    const mcqDiv = document.getElementById('mcq-options');
    if (q.options && q.options.length === 4) {
      mcqDiv.classList.remove('hidden');
      q.options.forEach((opt, i) => document.getElementById(`mcq-opt-${i}`).textContent = opt);
      if (mcqAnswers[currentIndex] !== undefined) {
        document.querySelector(`input[name="mcq-answer"][value="${mcqAnswers[currentIndex]}"]`).checked = true;
      }
    } else {
      mcqDiv.classList.add('hidden');
    }

    document.getElementById('answer-input').value = localStorage.getItem(`paid9_${currentIndex}`) || '';
  }

  function gotoQuestion(i) {
    if (examLocked || i < 0 || i >= questions.length) return;
    currentIndex = i;
    renderCurrentQuestion();
    renderQuestionsList();
  }

  function startTimer() {
    let timeLeft = 3600;
    timerInterval = setInterval(() => {
      timeLeft--;
      const m = Math.floor(timeLeft / 60);
      const s = timeLeft % 60;
      document.getElementById('timer').textContent = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
      if (timeLeft <= 300) document.getElementById('timer').className = 'text-xl font-semibold text-red-400';
      if (timeLeft <= 0) {
        clearInterval(timerInterval);
        finalSubmitExam();
      }
    }, 1000);
  }

  async function finalSubmitExam() {
    if (examLocked) return;
    examLocked = true;
    const finalSubmitBtn = document.getElementById('finalSubmitBtn');
    const submitText = document.getElementById('submitText');
    const submitSpinner = document.getElementById('submitSpinner');
    finalSubmitBtn.disabled = true;
    submitSpinner.classList.remove('hidden');
    submitText.textContent = 'Submitting...';

    try {
      await saveAllSubmissions();
      localStorage.removeItem('examSubmissions');
      localStorage.removeItem('currentContestId');
      window.location.href = `result.html?contestId=paid-9&from=exam`;
    } catch (error) {
      console.error('Submit error:', error);
      showToast('Save failed. Try again.', 'error');
      finalSubmitBtn.disabled = false;
      submitSpinner.classList.add('hidden');
      submitText.textContent = '‚úÖ Submit & View Result';
      examLocked = false;
    }
  }

  // ‚úÖ MAIN INIT - PERFECT ORDER
  document.addEventListener('DOMContentLoaded', async () => {
    console.log('üöÄ CodeRush PAID-9 LOADED ‚úÖ');
    
    // Auth check
    const { data: { user } } = await supabaseClient.auth.getUser();
    if (!user) {
      alert('Please login first!');
      window.location.href = 'index.html';
      return;
    }

    localStorage.setItem('currentContestId', 'paid-9');
    
    renderQuestionsList();
    renderCurrentQuestion();
    startTimer();

    // ‚úÖ ALL BUTTONS - AFTER DOM LOADED
    document.getElementById('saveProgressBtn').onclick = async () => {
      try {
        await saveAllSubmissions();
        showToast('‚úÖ Progress saved to cloud!');
      } catch (error) {
        console.error('Save error:', error);
        questions.forEach((q, i) => {
          localStorage.setItem(`paid9_${i}`, document.getElementById('answer-input').value || '');
        });
        showToast('üíæ Saved locally - Submit to see results!', 'warning');
      }
    };

    document.getElementById('save-answer-btn').onclick = function() {
      const selected = document.querySelector('input[name="mcq-answer"]:checked');
      if (selected) mcqAnswers[currentIndex] = parseInt(selected.value);
      localStorage.setItem(`paid9_${currentIndex}`, document.getElementById('answer-input').value);
      renderQuestionsList();
      showToast('‚úÖ Answer saved!');
    };

    document.getElementById('finalSubmitBtn').onclick = finalSubmitExam;
    document.getElementById('prev-btn').onclick = () => gotoQuestion(currentIndex-1);
    document.getElementById('next-btn').onclick = () => gotoQuestion(currentIndex+1);
    
    document.addEventListener('change', (e) => {
      if (e.target.name === 'mcq-answer') {
        mcqAnswers[currentIndex] = parseInt(e.target.value);
        renderQuestionsList();
      }
    });
  });
</script>

</body>
</html>
