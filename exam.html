
<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Contest Exam – CodeRush</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
  </style>
</head>

<body class="min-h-screen text-slate-100 bg-slate-950
             bg-[radial-gradient(circle_at_top,_rgba(45,212,191,0.23),_transparent_52%),radial-gradient(circle_at_bottom,_rgba(37,99,235,0.22),_transparent_55%)]">

<main class="max-w-6xl mx-auto px-4 py-5 md:py-7 mt-6 mb-10
             bg-slate-900/80 border border-slate-800/60 rounded-2xl shadow-[0_0_40px_rgba(15,23,42,0.95)]">

  <!-- Top bar: contest info + timer -->
  <header class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
    <div>
      <p id="contest-type-badge" class="text-[11px] uppercase tracking-wide text-emerald-400 mb-1">
        <!-- JS se fill -->
      </p>
      <h1 id="contest-title" class="text-lg md:text-xl font-semibold mb-1">Loading contest...</h1>
      <p id="contest-meta" class="text-[11px] text-slate-400">
        <!-- Entry, prize, etc -->
      </p>
    </div>

    <div class="flex items-center gap-4">
      <div class="text-right">
        <p class="text-[11px] text-slate-400">Time remaining</p>
        <p id="timer" class="text-xl font-semibold text-emerald-400">--:--:--</p>
      </div>
      <button id="finish-btn"
        class="px-3 py-1.5 rounded-lg bg-emerald-500 text-slate-900 text-[11px] font-semibold">
        Finish & submit
      </button>
    </div>
  </header>

  <!-- Layout: questions list + current question -->
  <section class="grid md:grid-cols-[220px,1fr] gap-4 mt-4">
    <!-- Question list -->
    <aside class="bg-slate-900/80 border border-slate-800 rounded-2xl p-3 text-xs">
      <h2 class="text-[12px] font-semibold mb-2">Questions</h2>
      <div id="questions-list" class="space-y-1">
        <!-- JS se buttons -->
      </div>
    </aside>

    <!-- Question viewer -->
    <section class="bg-slate-900/80 border border-slate-800 rounded-2xl p-3 text-xs flex flex-col">
      <div class="mb-2 flex items-center justify-between">
        <div>
          <p id="question-label" class="text-[11px] text-slate-400 mb-0.5">Question</p>
          <h2 id="question-title" class="text-sm font-semibold">Loading...</h2>
        </div>
        <div id="question-tags" class="text-[11px] text-right text-slate-400">
          <!-- level / topic -->
        </div>
      </div>

      <div id="question-statement" class="text-[12px] text-slate-200 mb-3">
        <!-- statement -->
      </div>

      <label class="text-[11px] text-slate-300 mb-1">Your answer / code</label>
      <textarea id="answer-input"
        class="flex-1 min-h-[180px] w-full bg-slate-950/70 border border-slate-800 rounded-xl px-3 py-2 text-[12px] text-slate-100 focus:outline-none focus:ring-1 focus:ring-emerald-500"
        placeholder="Type your solution here..."></textarea>

      <div class="mt-3 flex items-center justify-between">
        <button id="save-answer-btn"
          class="px-3 py-1.5 rounded-lg border border-emerald-500 text-emerald-300 text-[11px] font-semibold">
          Save answer
        </button>

        <div class="flex gap-2">
          <button id="prev-btn"
            class="px-3 py-1.5 rounded-lg border border-slate-700 text-[11px] text-slate-200">
            Previous
          </button>
          <button id="next-btn"
            class="px-3 py-1.5 rounded-lg bg-slate-100 text-slate-900 text-[11px] font-semibold">
            Next
          </button>
        </div>
      </div>
    </section>
  </section>
</main>

<script src="contests-config.js"></script>
<script>
  // ====== Supabase client (same as other pages) ======
  const SUPABASE_URL = 'https://tghtgygjawhrcgtwhrej.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRnaHRneWdqYXdocmNndHdocmVqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5OTM0MjksImV4cCI6MjA4MTU2OTQyOX0.Q-Ht_IFcPZPIHO5905o70EDya2yFdVP-9LjDmjkle38';
  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // ====== Helpers ======
  function getContestIdFromUrl() {
    const params = new URLSearchParams(window.location.search);
    return params.get("contestId");
  }

  function findContestById(id) {
    return Array.isArray(CONTESTS) ? CONTESTS.find(c => c.id === id) : null;
  }

  // Random questions helper (tumhara existing pattern, yahan simple q1/q2/q3 assume)
  const QUESTION_BANK = {
    // Example structure; actual questions tumhare contests-config.js ya alag JS se aa rahe hon to uske according use karo
    default: [
      { id: 'q1', title: 'Question 1', statement: '...', level: 'Easy', topic: 'Arrays' },
      { id: 'q2', title: 'Question 2', statement: '...', level: 'Medium', topic: 'Strings' },
      { id: 'q3', title: 'Question 3', statement: '...', level: 'Hard', topic: 'DP' }
    ]
  };

  function pickQuestionsForContest(contestId) {
    // Abhi ke लिए simple: default 3 questions
    return QUESTION_BANK.default;
  }

  // ====== Exam state ======
  let contestId = null;
  let contestConfig = null;
  let questions = [];
  let currentIndex = 0;
  let timerInterval = null;
  let examLocked = false; // timer ke baad true

  function getAnswerStorageKey(questionId) {
    return `answer_${contestId}_${questionId}`;
  }

  async function checkAlreadyFinished() {
    // Agar leaderboard me already entry hai to direct result page pe bhej do
    const { data: { user } } = await supabaseClient.auth.getUser();
    if (!user) {
      window.location.href = 'index.html';
      return true;
    }

    const { data, error } = await supabaseClient
      .from('leaderboard')
      .select('score')
      .eq('user_id', user.id)
      .eq('contest_id', contestId)
      .maybeSingle(); // ek row ya null[web:55]

    if (error) {
      console.warn('Leaderboard check error (ignored):', error);
      return false;
    }

    if (data) {
      // contest already given
      window.location.href = `results.html?contestId=${contestId}`;
      return true;
    }

    return false;
  }

  // ====== Timer ======
  function startTimer(totalSeconds = 60 * 60) { // 1 hour
    let remaining = totalSeconds;
    const timerEl = document.getElementById('timer');

    function render() {
      const h = String(Math.floor(remaining / 3600)).padStart(2, '0');
      const m = String(Math.floor((remaining % 3600) / 60)).padStart(2, '0');
      const s = String(remaining % 60).padStart(2, '0');
      timerEl.textContent = `${h}:${m}:${s}`;
    }

    render();

    timerInterval = setInterval(() => {
      remaining--;
      if (remaining <= 0) {
        clearInterval(timerInterval);
        timerEl.textContent = '00:00:00';
        autoSubmitExam(); // timer खत्म होते ही auto submit
        return;
      }
      render();
    }, 1000);
  }

  // ====== UI render ======
  function renderContestHeader() {
    const typeBadge = document.getElementById('contest-type-badge');
    const titleEl = document.getElementById('contest-title');
    const metaEl = document.getElementById('contest-meta');

    if (!contestConfig) return;

    typeBadge.textContent = contestConfig.type === 'free' ? 'Free contest' : 'Paid contest';
    typeBadge.classList.toggle('text-emerald-400', contestConfig.type === 'free');
    typeBadge.classList.toggle('text-amber-400', contestConfig.type === 'paid');

    titleEl.textContent = contestConfig.title || 'Contest';

    metaEl.textContent =
      `Entry ${contestConfig.entryFee === 0 ? 'Free' : '₹' + contestConfig.entryFee} • ` +
      `Total prize ₹${contestConfig.totalPrize} • ` +
      `Top ${contestConfig.maxWinners} students get rewards`;
  }

  function renderQuestionsList() {
    const list = document.getElementById('questions-list');
    list.innerHTML = '';

    questions.forEach((q, index) => {
      const btn = document.createElement('button');
      btn.className =
        'w-full text-left px-3 py-1.5 rounded-lg border text-[11px] mb-1 ' +
        (index === currentIndex
          ? 'bg-emerald-500/20 border-emerald-500 text-emerald-300'
          : 'bg-slate-900 border-slate-700 text-slate-200');
      btn.textContent = `Q${index + 1} • ${q.level || ''}`;
      btn.onclick = () => {
        if (examLocked) return;
        saveCurrentAnswer();
        currentIndex = index;
        renderCurrentQuestion();
        renderQuestionsList();
      };
      list.appendChild(btn);
    });
  }

  function renderCurrentQuestion() {
    const q = questions[currentIndex];
    if (!q) return;

    document.getElementById('question-label').textContent = `Question ${currentIndex + 1}`;
    document.getElementById('question-title').textContent = q.title || '';
    document.getElementById('question-statement').textContent = q.statement || '';

    document.getElementById('question-tags').textContent =
      `${q.level || ''}${q.topic ? ' • ' + q.topic : ''}`;

    const saved = localStorage.getItem(getAnswerStorageKey(q.id)) || '';
    document.getElementById('answer-input').value = saved;
  }

  // ====== Answers ======
  async function saveAnswer(questionId, value) {
    localStorage.setItem(getAnswerStorageKey(questionId), value || '');

    try {
      const { data: { user } } = await supabaseClient.auth.getUser();
      if (!user) {
        console.warn('No logged-in user, skipping DB save');
        return;
      }

      const { error } = await supabaseClient
        .from('submissions')
        .insert({
          user_id: user.id,
          contest_id: contestId,
          question_id: questionId,
          code: value || '',
          language: 'text'
        });

      if (error) {
        console.error('Save submission error:', error);
      }
    } catch (e) {
      console.error('Save submission exception:', e);
    }
  }

  function saveCurrentAnswer() {
    const q = questions[currentIndex];
    if (!q) return;
    const value = document.getElementById('answer-input').value;
    saveAnswer(q.id, value);
  }

  async function saveAllAnswers() {
    for (const q of questions) {
      const key = getAnswerStorageKey(q.id);
      const value = document.getElementById('answer-input').value;

      // current question input se latest, baaki localStorage se
      const finalValue = (q.id === questions[currentIndex].id)
        ? value
        : (localStorage.getItem(key) || '');

      await saveAnswer(q.id, finalValue);
    }
  }

  // ====== Finish / Auto submit ======
  async function autoSubmitExam() {
    if (examLocked) return;
    examLocked = true;

    // Buttons disable
    document.getElementById('finish-btn').disabled = true;
    document.getElementById('finish-btn').textContent = 'Submitting...';
    document.getElementById('finish-btn').classList.add('opacity-60', 'cursor-not-allowed');

    // Sab answers save
    await saveAllAnswers();

    // Simple score fallback: jitne attempted questions, utna * 100 (real score result page pe calculate hoga)
    let fallbackScore = 0;
    questions.forEach(q => {
      const val = localStorage.getItem(getAnswerStorageKey(q.id)) || '';
      if (val.trim().length > 0) fallbackScore += 100;
    });

    // Redirect to result page
    window.location.href = `results.html?contestId=${contestId}&score=${fallbackScore}`;
  }

  async function finishExamClick() {
    const confirmFinish = confirm('Kya aap exam finish karna chahte hain? Baad me questions edit nahi kar paoge.');
    if (!confirmFinish) return;
    await autoSubmitExam();
  }

  // ====== Init ======
  async function initExamPage() {
    contestId = getContestIdFromUrl();
    contestConfig = findContestById(contestId);

    if (!contestId || !contestConfig) {
      alert('Invalid contest.');
      window.location.href = 'dashboard.html';
      return;
    }

    // 1) Pehle check karo user already finish to nahi kar chuka
    const already = await checkAlreadyFinished();
    if (already) return; // function ne redirect kar diya

    // 2) Questions pick karo
    questions = pickQuestionsForContest(contestId);
    currentIndex = 0;

    // 3) UI render
    renderContestHeader();
    renderQuestionsList();
    renderCurrentQuestion();

    // 4) Timer start
    startTimer(60 * 60); // 1 hour
  }

  // Event listeners
  document.getElementById('save-answer-btn').addEventListener('click', () => {
    if (examLocked) return;
    saveCurrentAnswer();
    alert('Answer saved!');
  });

  document.getElementById('prev-btn').addEventListener('click', () => {
    if (examLocked) return;
    saveCurrentAnswer();
    if (currentIndex > 0) {
      currentIndex--;
      renderCurrentQuestion();
      renderQuestionsList();
    }
  });

  document.getElementById('next-btn').addEventListener('click', () => {
    if (examLocked) return;
    saveCurrentAnswer();
    if (currentIndex < questions.length - 1) {
      currentIndex++;
      renderCurrentQuestion();
      renderQuestionsList();
    }
  });

  document.getElementById('finish-btn').addEventListener('click', finishExamClick);

  document.addEventListener('DOMContentLoaded', initExamPage);
</script>

</body>
</html>
