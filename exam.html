<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Contest Exam ‚Äì CodeRush</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
    .monaco-editor { height: 200px !important; }
  </style>
</head>

<body class="min-h-screen text-slate-100 bg-slate-950 bg-[radial-gradient(circle_at_top,_rgba(45,212,191,0.23),_transparent_52%),radial-gradient(circle_at_bottom,_rgba(37,99,235,0.22),_transparent_55%)]">

<main class="max-w-6xl mx-auto px-4 py-5 md:py-7 mt-6 mb-10 bg-slate-900/80 border border-slate-800/60 rounded-2xl shadow-[0_0_40px_rgba(15,23,42,0.95)]">

  <!-- Header -->
  <header class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
    <div>
      <p id="contest-type-badge" class="text-[11px] uppercase tracking-wide text-emerald-400 mb-1">Loading...</p>
      <h1 id="contest-title" class="text-lg md:text-xl font-semibold mb-1">Loading contest...</h1>
      <p id="contest-meta" class="text-[11px] text-slate-400"></p>
    </div>
    <div class="flex items-center gap-4">
      <div class="text-right">
        <p class="text-[11px] text-slate-400">Time remaining</p>
        <p id="timer" class="text-xl font-semibold text-emerald-400">--:--:--</p>
      </div>
      <button id="finish-btn" class="px-6 py-2 rounded-lg bg-gradient-to-r from-red-500 to-red-600 text-white text-sm font-bold hover:from-red-600 hover:to-red-700 shadow-lg">
        üèÅ SUBMIT EXAM & SEE RANK
      </button>
    </div>
  </header>

  <section class="grid md:grid-cols-[220px,1fr] gap-4 mt-4">
    <aside class="bg-slate-900/80 border border-slate-800 rounded-2xl p-3 text-xs">
      <h2 class="text-[12px] font-semibold mb-2">Questions (<span id="question-count">0</span>)</h2>
      <div id="questions-list" class="space-y-1 max-h-96 overflow-y-auto"></div>
    </aside>

    <section class="bg-slate-900/80 border border-slate-800 rounded-2xl p-3 text-xs flex flex-col h-[70vh]">
      <div class="mb-2 flex items-center justify-between">
        <div>
          <p id="question-label" class="text-[11px] text-slate-400 mb-0.5">Question 1</p>
          <h2 id="question-title" class="text-sm font-semibold">Loading...</h2>
        </div>
        <div id="question-tags" class="text-[11px] text-right text-slate-400"></div>
      </div>

      <div id="question-statement" class="text-[12px] text-slate-200 mb-3 min-h-[120px] p-4 bg-slate-800/50 rounded-lg overflow-y-auto"></div>

      <!-- MCQ Options -->
      <div id="mcq-options" class="space-y-2 mb-4 hidden">
        <label class="flex items-center p-3 bg-slate-800/50 rounded-lg border-2 border-slate-700 cursor-pointer hover:border-emerald-500 hover:bg-emerald-500/10">
          <input type="radio" name="mcq-answer" value="0" class="w-4 h-4 text-emerald-500 ml-3">
          <span id="mcq-opt-0" class="ml-3 text-sm"></span>
        </label>
        <label class="flex items-center p-3 bg-slate-800/50 rounded-lg border-2 border-slate-700 cursor-pointer hover:border-emerald-500 hover:bg-emerald-500/10">
          <input type="radio" name="mcq-answer" value="1" class="w-4 h-4 text-emerald-500 ml-3">
          <span id="mcq-opt-1" class="ml-3 text-sm"></span>
        </label>
        <label class="flex items-center p-3 bg-slate-800/50 rounded-lg border-2 border-slate-700 cursor-pointer hover:border-emerald-500 hover:bg-emerald-500/10">
          <input type="radio" name="mcq-answer" value="2" class="w-4 h-4 text-emerald-500 ml-3">
          <span id="mcq-opt-2" class="ml-3 text-sm"></span>
        </label>
        <label class="flex items-center p-3 bg-slate-800/50 rounded-lg border-2 border-slate-700 cursor-pointer hover:border-emerald-500 hover:bg-emerald-500/10">
          <input type="radio" name="mcq-answer" value="3" class="w-4 h-4 text-emerald-500 ml-3">
          <span id="mcq-opt-3" class="ml-3 text-sm"></span>
        </label>
      </div>

      <label class="text-[11px] text-slate-300 mb-1 block">Your answer / code</label>
      <textarea id="answer-input" class="flex-1 min-h-[180px] w-full bg-slate-950/70 border border-slate-800 rounded-xl px-3 py-2 text-[12px] text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-500 resize-none" placeholder="Type your solution here..."></textarea>

      <div class="mt-4 flex items-center justify-between">
        <div class="flex items-center gap-2">
          <button id="save-answer-btn" class="px-4 py-2 rounded-lg border-2 border-emerald-500 text-emerald-300 text-sm font-semibold hover:bg-emerald-500/20">üíæ Save</button>
          <button id="run-debug-btn" class="px-4 py-2 rounded-lg border border-slate-600 text-slate-200 text-sm hover:bg-slate-800">‚ñ∂Ô∏è Run</button>
        </div>
        <div class="flex gap-2">
          <button id="prev-btn" class="px-4 py-2 rounded-lg border border-slate-700 text-sm text-slate-200 hover:bg-slate-800">‚Üê Prev</button>
          <button id="next-btn" class="px-4 py-2 rounded-lg bg-emerald-500 text-slate-900 text-sm font-semibold hover:bg-emerald-600">Next ‚Üí</button>
        </div>
      </div>
    </section>
  </section>
</main>

<script>
  // ‚úÖ FIXED: Supabase client creation
  const supabaseUrl = 'https://tghtgygjawhrcgtwhrej.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRnaHRneWdqYXdocmNndHdocmVqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5OTM0MjksImV4cCI6MjA4MTU2OTQyOX0.Q-Ht_IFcPZPIHO5905o70EDya2yFdVP-9LjDmjkle38';
  const supabase = Supabase.createClient(supabaseUrl, supabaseKey);

  // State
  let contestId = new URLSearchParams(window.location.search).get('contestId') || 'paid-9';
  let questions = [], currentIndex = 0, timerInterval, examLocked = false, mcqAnswers = {};

  // Contest configs
  const CONTESTS = {
    'paid-9': { type: 'paid', title: 'PAID-9 Contest (‚Çπ9)', entryFee: 9, totalPrize: 900 },
    'free': { type: 'free', title: 'Free Daily Contest', entryFee: 0, totalPrize: 0 }
  };

  // ‚úÖ FIXED: Questions with fallback data (file missing hone pe demo questions load honge)
  async function loadQuestions() {
    try {
      console.log(`üîç Loading ./questions/questions-${contestId}.json`);
      const response = await fetch(`./questions/questions-${contestId}.json?t=${Date.now()}`);
      
      if (!response.ok) {
        console.warn('‚ùå Questions file not found, using demo questions');
        return loadDemoQuestions();
      }
      
      questions = await response.json();
      console.log(`‚úÖ ${questions.length} questions loaded!`);
    } catch (error) {
      console.error('‚ùå Questions load failed:', error);
      return loadDemoQuestions();
    }
    
    document.getElementById('question-count').textContent = questions.length;
    return true;
  }

  // Demo questions jab real file missing ho
  function loadDemoQuestions() {
    questions = [
      {
        id: 1,
        question: "What is the output of console.log(0.1 + 0.2 === 0.3)?",
        statement: "Floating point precision issue in JavaScript. Check the result.",
        type: "mcq",
        options: ["true", "false", "undefined", "0"],
        answer: 1, // false
        topic: "JavaScript Basics"
      },
      {
        id: 2,
        question: "Array methods practice",
        statement: `Write a function to find second largest number in array: [3, 1, 4, 1, 5, 9]`,
        type: "coding",
        topic: "Arrays"
      },
      {
        id: 3,
        question: "What does this return?",
        statement: "console.log(typeof null);",
        type: "mcq",
        options: ["null", "undefined", "object", "string"],
        answer: 2, // object
        topic: "Type Coercion"
      }
    ];
    document.getElementById('question-count').textContent = questions.length;
    return true;
  }

  function initExam() {
    const contestConfig = CONTESTS[contestId] || CONTESTS['free'];
    
    document.getElementById('contest-type-badge').textContent = contestConfig.type === 'free' ? 'FREE' : `PAID ‚Çπ${contestConfig.entryFee}`;
    document.getElementById('contest-type-badge').className = `text-[11px] uppercase tracking-wide ${contestConfig.type === 'free' ? 'text-emerald-400' : 'text-amber-400'} mb-1`;
    document.getElementById('contest-title').textContent = contestConfig.title;
    document.getElementById('contest-meta').textContent = `Razorpay Verified ‚Ä¢ Live Leaderboard ‚Ä¢ Instant Score`;

    renderQuestionsList();
    if (questions.length > 0) renderCurrentQuestion();
    startTimer();
  }

  function renderQuestionsList() {
    const list = document.getElementById('questions-list');
    list.innerHTML = questions.map((q, i) => {
      const isAnswered = mcqAnswers[i] !== undefined || localStorage.getItem(`answer_${contestId}_${i}`);
      return `<button class="w-full text-left p-2 rounded-lg border text-xs mb-1 transition-all ${i===currentIndex ? 'bg-emerald-500/30 border-emerald-500 shadow-md' : (isAnswered ? 'bg-blue-500/20 border-blue-500' : 'border-slate-700 bg-slate-900/50')} hover:bg-emerald-500/20 hover:border-emerald-400" onclick="gotoQuestion(${i})">
        Q${i+1} ${q.type==='coding'?'üíª':'‚ùì'} ${isAnswered?'‚úÖ':''}
      </button>`;
    }).join('');
  }

  function renderCurrentQuestion() {
    const q = questions[currentIndex];
    if (!q) return;
    
    document.getElementById('question-label').textContent = `Question ${currentIndex+1}/${questions.length}`;
    document.getElementById('question-title').textContent = q.question || `Q${currentIndex+1}`;
    document.getElementById('question-statement').innerHTML = q.statement || 'Question loading...';
    document.getElementById('question-tags').textContent = `${q.type?.toUpperCase()||'MCQ'} ‚Ä¢ ${q.topic||'Basic'}`;

    // MCQ options
    const mcqDiv = document.getElementById('mcq-options');
    if (q.options && q.options.length === 4) {
      mcqDiv.classList.remove('hidden');
      q.options.forEach((opt, i) => {
        document.getElementById(`mcq-opt-${i}`).textContent = opt;
      });
      // Restore saved MCQ answer
      const savedAnswer = mcqAnswers[currentIndex];
      if (savedAnswer !== undefined) {
        document.querySelector(`input[name="mcq-answer"][value="${savedAnswer}"]`).checked = true;
      }
    } else {
      mcqDiv.classList.add('hidden');
    }

    // Restore textarea answer
    document.getElementById('answer-input').value = localStorage.getItem(`answer_${contestId}_${currentIndex}`) || '';
  }

  function gotoQuestion(i) {
    if (examLocked || i < 0 || i >= questions.length) return;
    currentIndex = i;
    renderCurrentQuestion();
    renderQuestionsList();
  }

  function startTimer() {
    let timeLeft = 5400; // 90 minutes = 5400 seconds
    document.getElementById('timer').className = 'text-xl font-semibold text-emerald-400';
    
    timerInterval = setInterval(() => {
      timeLeft--;
      const h = Math.floor(timeLeft / 3600);
      const m = Math.floor((timeLeft % 3600) / 60);
      const s = timeLeft % 60;
      
      document.getElementById('timer').textContent = 
        `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
      
      // Warning when < 10 min left
      if (timeLeft <= 600) {
        document.getElementById('timer').className = 'text-xl font-semibold text-red-400 animate-pulse';
      }
      
      if (timeLeft <= 0) {
        clearInterval(timerInterval);
        submitExam();
      }
    }, 1000);
  }

  // ‚úÖ FIXED: Proper score calculation
  async function submitExam() {
    if (examLocked) return;
    examLocked = true;
    
    // Save all answers first
    document.getElementById('save-answer-btn').click();
    
    try {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        alert('‚ùå Pehle login karo! Dashboard se login karke exam do.');
        window.location.href = 'dashboard.html';
        return;
      }

      // Calculate score properly
      let mcqScore = 0, totalQuestions = 0;
      questions.forEach((q, i) => {
        if (q.type === 'mcq' && q.answer !== undefined) {
          totalQuestions++;
          if (mcqAnswers[i] == q.answer) { // loose equality for string/number
            mcqScore += 4;
          }
        }
      });

      const percentage = totalQuestions > 0 ? Math.round((mcqScore / (totalQuestions * 4)) * 100) : 0;

      // Save to Supabase
      const { error } = await supabase
        .from('scores')
        .insert({
          user_id: user.id,
          contest_id: contestId,
          mcq_score: mcqScore,
          coding_score: 0, // TODO: implement later
          total_score: mcqScore,
          percentage: percentage,
          completed_at: new Date().toISOString()
        });

      if (error) {
        console.error('‚ùå Save error:', error);
        alert('‚ùå Score save nahi hua! Console check karo.');
      } else {
        console.log(`‚úÖ Score saved! MCQ: ${mcqScore}/${totalQuestions*4} (${percentage}%)`);
        alert(`üéâ Exam Submitted!\nMCQ Score: ${mcqScore}/${totalQuestions*4}\nPercentage: ${percentage}%\n\nLeaderboard pe dekho!`);
        window.location.href = 'dashboard.html';
      }
    } catch (error) {
      console.error('Submit error:', error);
      alert('‚ùå Kuch gadbad hui! Console check karo.');
    }
  }

  // Event listeners
  document.addEventListener('DOMContentLoaded', async () => {
    console.log('üöÄ CodeRush Exam Engine Starting...');
    
    const loaded = await loadQuestions();
    if (loaded) {
      initExam();
    } else {
      document.getElementById('question-statement').innerHTML = 
        `<div class="text-red-400 text-center p-8">
          ‚ùå Questions file missing!<br>
          <small>./questions/questions-${contestId}.json banao ya dashboard se doosra contest choose karo</small>
        </div>`;
    }

    // Event bindings
    document.getElementById('save-answer-btn').onclick = saveCurrentAnswer;
    document.getElementById('finish-btn').onclick = submitExam;
    document.getElementById('prev-btn').onclick = () => gotoQuestion(currentIndex - 1);
    document.getElementById('next-btn').onclick = () => gotoQuestion(currentIndex + 1);
    document.getElementById('run-debug-btn').onclick = () => {
      console.log('MCQ Answers:', mcqAnswers);
      console.log('Current question:', questions[currentIndex]);
    };

    // Auto-save MCQ changes
    document.addEventListener('change', (e) => {
      if (e.target.name === 'mcq-answer') {
        mcqAnswers[currentIndex] = parseInt(e.target.value);
        renderQuestionsList();
      }
    });
  });

  function saveCurrentAnswer() {
    // Save MCQ
    const selected = document.querySelector('input[name="mcq-answer"]:checked');
    if (selected) {
      mcqAnswers[currentIndex] = parseInt(selected.value);
    }
    
    // Save textarea
    const textarea = document.getElementById('answer-input');
    localStorage.setItem(`answer_${contestId}_${currentIndex}`, textarea.value);
    
    renderQuestionsList();
    // Visual feedback
    const btn = document.getElementById('save-answer-btn');
    const original = btn.textContent;
    btn.textContent = '‚úÖ Saved!';
    btn.style.backgroundColor = '#10b981';
    setTimeout(() => {
      btn.textContent = original;
      btn.style.backgroundColor = '';
    }, 1000);
  }
</script>
</body>
</html>
