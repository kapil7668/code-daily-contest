<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Contest Exam – CodeRush</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * { font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
  </style>

  <!-- Supabase client -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    const supabaseUrl = "https://tghtgygjawhrcgtwhrej.supabase.co"; // tumhara URL
    const supabaseKey = "YAHAN_APNA_ANON_KEY_DALO";                 // tumhara anon key
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
  </script>
</head>

<body class="min-h-screen text-slate-100 bg-slate-950
             bg-[radial-gradient(circle_at_top,_rgba(45,212,191,0.23),_transparent_52%),radial-gradient(circle_at_bottom,_rgba(37,99,235,0.22),_transparent_55%)]">

<main class="max-w-6xl mx-auto px-4 py-6 mt-6 mb-10 bg-slate-900/85 border border-slate-800/60 rounded-2xl shadow-[0_0_40px_rgba(15,23,42,0.95)]">

  <!-- Header: contest name + timer -->
  <div id="exam-header" class="flex items-center justify-between mb-4">
    <!-- JS se fill hoga -->
  </div>

  <!-- Layout: left question list, right question detail -->
  <div class="grid grid-cols-12 gap-4">
    <!-- Left: questions list -->
    <aside class="col-span-12 md:col-span-3 bg-slate-900 border border-slate-800 rounded-xl p-3 text-xs" id="question-list">
      <!-- JS se fill hoga -->
    </aside>

    <!-- Right: current question -->
    <section class="col-span-12 md:col-span-9 bg-slate-900 border border-slate-800 rounded-xl p-4 text-sm" id="question-area">
      <!-- JS se fill hoga -->
    </section>
  </div>

</main>

<script src="contests-config.js"></script>
<script>
  // ---------- Helpers ----------
  function getContestIdFromUrl() {
    const params = new URLSearchParams(window.location.search);
    return params.get("contestId");
  }

  function findContestById(id) {
    return Array.isArray(CONTESTS) ? CONTESTS.find(c => c.id === id) : null;
  }

  // ---------- QUESTION BANK (contest-wise) ----------
  const QUESTION_BANK = {
    "paid-9": [
      { id: "p9-q1", title: "Two Sum", statement: "Given an array and a target, return indices of the two numbers such that they add up to target.", level: "Easy", topic: "Arrays" },
      { id: "p9-q2", title: "Maximum Subarray", statement: "Find the contiguous subarray with maximum sum.", level: "Easy", topic: "Kadane" },
      { id: "p9-q3", title: "Valid Parentheses", statement: "Check if the input string with brackets is valid.", level: "Easy", topic: "Stack" }
    ],

    "free-200": [
      { id: "f200-q1", title: "Find Minimum", statement: "Given N numbers, print the minimum element.", level: "Easy", topic: "Arrays" },
      { id: "f200-q2", title: "Reverse String", statement: "Reverse the given string without using extra library functions.", level: "Easy", topic: "Strings" },
      { id: "f200-q3", title: "Sum of Digits", statement: "Given an integer, find sum of its digits.", level: "Easy", topic: "Math" }
    ],

    "paid-49": [
      { id: "p49-q1", title: "Binary Search", statement: "Implement binary search on a sorted array.", level: "Easy", topic: "Binary Search" },
      { id: "p49-q2", title: "Rotate Array", statement: "Rotate array by k steps to the right.", level: "Easy", topic: "Arrays" },
      { id: "p49-q3", title: "First Unique Character", statement: "Find index of first non-repeating character in a string.", level: "Easy", topic: "Hash Map" }
    ],

    "paid-99": [
      { id: "p99-q1", title: "Two Pointers Sum", statement: "Given sorted array and target, check if any pair has sum = target.", level: "Easy", topic: "Two Pointers" },
      { id: "p99-q2", title: "Sort 0 1 2", statement: "Sort array containing only 0,1,2.", level: "Easy", topic: "Sorting" },
      { id: "p99-q3", title: "Anagram Check", statement: "Check if two strings are anagrams.", level: "Easy", topic: "Strings" }
    ],

    "paid-149": [
      { id: "p149-q1", title: "Merge Intervals", statement: "Given intervals, merge all overlapping intervals.", level: "Medium", topic: "Intervals" },
      { id: "p149-q2", title: "Longest Substring", statement: "Length of longest substring without repeating characters.", level: "Medium", topic: "Sliding Window" },
      { id: "p149-q3", title: "Top K Frequent", statement: "Return k most frequent elements from array.", level: "Medium", topic: "Heap" }
    ],

    "paid-199": [
      { id: "p199-q1", title: "Kth Largest Element", statement: "Find kth largest element in an unsorted array.", level: "Medium", topic: "Heap" },
      { id: "p199-q2", title: "Number of Islands", statement: "Given grid of 0/1, count number of islands.", level: "Medium", topic: "DFS" },
      { id: "p199-q3", title: "Course Schedule", statement: "Check if you can finish all courses given prerequisites.", level: "Medium", topic: "Graph / Topo Sort" }
    ],

    "free-1": [
      { id: "f1-q1", title: "Print Hello", statement: "Print 'Hello, World!'.", level: "Easy", topic: "Basics" },
      { id: "f1-q2", title: "Add Two Numbers", statement: "Given two integers, output their sum.", level: "Easy", topic: "Math" },
      { id: "f1-q3", title: "Odd or Even", statement: "Check if a number is odd or even.", level: "Easy", topic: "Conditions" }
    ]
  };

  function pickRandomQuestionsForContest(contestId, count = 3) {
    const pool = QUESTION_BANK[contestId] || [];
    const copy = [...pool];
    const selected = [];
    while (copy.length && selected.length < count) {
      const idx = Math.floor(Math.random() * copy.length);
      selected.push(copy.splice(idx, 1)[0]);
    }
    return selected;
  }

  // ---------- Exam state ----------
  let currentQuestionIndex = 0;
  let selectedQuestions = [];
  let remainingSeconds = 60 * 60; // 60 mins default
  let timerInterval = null;
  let currentContestId = null;

  // ---------- Answer save helpers ----------
  function makeAnswerKey(contestId, questionId) {
    return `answer_${contestId}_${questionId}`;
  }

  function loadSavedAnswer(contestId, questionId) {
    const key = makeAnswerKey(contestId, questionId);
    return localStorage.getItem(key) || "";
  }

  async function saveAnswer(contestId, questionId, value) {
    const key = makeAnswerKey(contestId, questionId);
    // Local backup
    localStorage.setItem(key, value);

    try {
      const {
        data: { user },
        error: userError
      } = await supabase.auth.getUser();
      if (userError || !user) {
        console.warn("No logged-in user, skipping DB save");
        return;
      }

      const { error } = await supabase
        .from("submissions")
        .upsert(
          {
            user_id: user.id,
            contest_id: contestId,
            question_id: questionId,
            code: value,
            language: "text"
          },
          { onConflict: "user_id,contest_id,question_id" }
        );

      if (error) {
        console.error("Supabase save error", error);
      }
    } catch (e) {
      console.error("Unexpected save error", e);
    }
  }

  // ---------- Dummy scoring (URL ke through result.html ko bhejne ke liye) ----------
  function calculateDummyScore() {
    if (!currentContestId || !selectedQuestions.length) return 0;
    let score = 0;

    selectedQuestions.forEach((q, index) => {
      const ans = loadSavedAnswer(currentContestId, q.id).trim();
      if (!ans) return;
      if (index === 1) score += 100;
      if (index === 2) score += 200;
    });

    return score;
  }

  // ---------- Finish exam -> result page ----------
  function finishExam() {
    const contestId = currentContestId || getContestIdFromUrl();
    const score = calculateDummyScore();
    window.location.href =
      `result.html?contestId=${encodeURIComponent(contestId)}&score=${encodeURIComponent(score)}`;
  }

  // ---------- Render header ----------
  function renderHeader(contest) {
    const header = document.getElementById("exam-header");
    if (!header) return;

    const entryText = contest.entryFee === 0
      ? "Free test"
      : `Entry ₹${contest.entryFee}`;

    header.innerHTML = `
      <div>
        <p class="text-[11px] uppercase tracking-wide ${
          contest.type === "free" ? "text-emerald-400" : "text-amber-400"
        } mb-1">
          ${contest.type === "free" ? "Free contest" : "Paid contest"}
        </p>
        <h1 class="text-xl font-semibold mb-1">${contest.title}</h1>
        <p class="text-slate-300 text-xs">
          ${entryText} • Min ${contest.minParticipants} students • Total prize ₹${contest.totalPrize}
        </p>
      </div>

      <div class="text-right">
        <p class="text-[11px] text-slate-400 mb-1">Time remaining</p>
        <p id="timer-text" class="text-lg font-semibold text-emerald-400">--:--:--</p>
        <button onclick="window.location.href='dashboard.html'"
          class="mt-2 px-3 py-1.5 rounded-lg border border-slate-600 text-[11px] text-slate-200">
          Exit exam
        </button>
        <button onclick="finishExam()"
          class="mt-2 ml-2 px-3 py-1.5 rounded-lg bg-emerald-500 text-slate-900 text-[11px] font-semibold">
          Finish &amp; view result
        </button>
      </div>
    `;
  }

  // ---------- Timer ----------
  function formatTime(sec) {
    const h = Math.floor(sec / 3600);
    const m = Math.floor((sec % 3600) / 60);
    const s = sec % 60;
    const pad = (x) => x.toString().padStart(2, "0");
    return `${pad(h)}:${pad(m)}:${pad(s)}`;
  }

  function startTimer() {
    const timerText = document.getElementById("timer-text");
    if (!timerText) return;

    timerText.textContent = formatTime(remainingSeconds);

    timerInterval = setInterval(() => {
      remainingSeconds--;
      if (remainingSeconds <= 0) {
        remainingSeconds = 0;
        timerText.textContent = formatTime(remainingSeconds);
        clearInterval(timerInterval);
        alert("Time is over!");
        finishExam();
        return;
      }
      timerText.textContent = formatTime(remainingSeconds);
    }, 1000);
  }

  // ---------- Questions list & detail ----------
  function renderQuestionList() {
    const list = document.getElementById("question-list");
    if (!list) return;

    list.innerHTML = `
      <p class="font-semibold mb-2 text-slate-100 text-sm">Questions</p>
      <div id="question-buttons" class="space-y-1"></div>
    `;

    const btnContainer = document.getElementById("question-buttons");

    selectedQuestions.forEach((q, index) => {
      const btn = document.createElement("button");
      btn.className =
        "w-full flex items-center justify-between px-3 py-2 rounded-lg text-xs " +
        (index === currentQuestionIndex
          ? "bg-emerald-500 text-slate-900"
          : "bg-slate-800 text-slate-200 hover:bg-slate-700");
      btn.textContent = `Q${index + 1}: ${q.title}`;
      btn.onclick = () => {
        currentQuestionIndex = index;
        renderQuestionList();
        renderCurrentQuestion();
      };
      btnContainer.appendChild(btn);
    });
  }

  function renderCurrentQuestion() {
    const area = document.getElementById("question-area");
    if (!area) return;
    const q = selectedQuestions[currentQuestionIndex];
    if (!q) {
      area.innerHTML = "<p class='text-red-400 text-sm'>No question loaded.</p>";
      return;
    }

    const saved = loadSavedAnswer(currentContestId, q.id);

    area.innerHTML = `
      <div class="flex items-center justify-between mb-2">
        <div>
          <p class="text-[11px] text-slate-400 mb-1">Question ${currentQuestionIndex + 1}</p>
          <h2 class="text-lg font-semibold mb-1">${q.title}</h2>
          <p class="text-[11px] text-slate-400">
            Level: <span class="text-emerald-400">${q.level}</span> • Topic: ${q.topic}
          </p>
        </div>
      </div>

      <p class="text-slate-200 text-sm mb-3">
        ${q.statement}
      </p>

      <div class="mb-3 text-xs text-slate-400">
        <p class="mb-1 font-semibold">Write your solution (pseudo / code) below:</p>
      </div>

      <textarea
        id="answer-box"
        class="w-full h-52 bg-slate-950 border border-slate-700 rounded-lg px-3 py-2 text-xs text-slate-100 focus:outline-none focus:border-emerald-400"
        placeholder="Write logic / code here (language of your choice)...">${saved}</textarea>

      <div class="flex items-center justify-between mt-3 text-xs">
        <div class="space-x-2">
          <button id="save-answer-btn"
            class="px-3 py-1.5 rounded-lg bg-slate-800 border border-slate-600 text-slate-200">
            Save answer
          </button>
          <button class="px-3 py-1.5 rounded-lg bg-slate-800 border border-slate-600 text-slate-200">
            Run test (dummy)
          </button>
        </div>
        <div class="space-x-2">
          <button id="prev-q"
            class="px-3 py-1.5 rounded-lg bg-slate-800 border border-slate-600 text-slate-200">
            Previous
          </button>
          <button id="next-q"
            class="px-3 py-1.5 rounded-lg bg-emerald-500 text-slate-900">
            Next
          </button>
        </div>
      </div>
    `;

    const prevBtn = document.getElementById("prev-q");
    const nextBtn = document.getElementById("next-q");
    const saveBtn = document.getElementById("save-answer-btn");
    const answerBox = document.getElementById("answer-box");

    prevBtn.onclick = () => {
      if (currentQuestionIndex > 0) {
        currentQuestionIndex--;
        renderQuestionList();
        renderCurrentQuestion();
      }
    };
    nextBtn.onclick = () => {
      if (currentQuestionIndex < selectedQuestions.length - 1) {
        currentQuestionIndex++;
        renderQuestionList();
        renderCurrentQuestion();
      }
    };
    saveBtn.onclick = () => {
      saveAnswer(currentContestId, q.id, answerBox.value);
      saveBtn.textContent = "Saved!";
      setTimeout(() => (saveBtn.textContent = "Save answer"), 1200);
    };
  }

  // ---------- Init ----------
  function initExamPage() {
    const contestId = getContestIdFromUrl();
    const contest = findContestById(contestId);

    if (!contest) {
      document.body.innerHTML = `
        <div class="min-h-screen flex items-center justify-center bg-slate-950 text-slate-100">
          <div class="bg-slate-900 border border-slate-800 rounded-xl px-5 py-4 text-sm">
            <p class="text-red-400 font-semibold mb-2">Invalid contest.</p>
            <a href="dashboard.html" class="text-emerald-400 underline text-xs">Back to dashboard</a>
          </div>
        </div>
      `;
      return;
    }

    currentContestId = contestId;
    remainingSeconds = 60 * 60;

    selectedQuestions = pickRandomQuestionsForContest(contestId, 3);
    if (!selectedQuestions.length) {
      alert("No questions configured for this contest yet.");
    }

    renderHeader(contest);
    renderQuestionList();
    renderCurrentQuestion();
    startTimer();
  }

  document.addEventListener("DOMContentLoaded", initExamPage);
</script>

</body>
</html>
