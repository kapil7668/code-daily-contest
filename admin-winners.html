<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin – Contest Winners | CodeRush</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
  </style>
</head>

<body class="min-h-screen text-slate-100 bg-slate-950
             bg-[radial-gradient(circle_at_top,_rgba(45,212,191,0.23),_transparent_52%),radial-gradient(circle_at_bottom,_rgba(37,99,235,0.22),_transparent_55%)]">

<main class="max-w-6xl mx-auto px-4 py-5 md:py-7 mt-6 mb-10
             bg-slate-900/80 border border-slate-800/60 rounded-2xl shadow-[0_0_40px_rgba(15,23,42,0.95)]">

  <header class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
    <div>
      <p class="text-[11px] uppercase tracking-wide text-amber-400 mb-1">Admin only</p>
      <h1 class="text-xl font-semibold mb-1">Contest winners panel</h1>
      <p class="text-[11px] text-slate-400">
        Select a contest to see Top N winners (based on <span class="text-emerald-400">score</span>).
      </p>
    </div>

    <div class="flex flex-col items-end gap-2 text-xs">
      <select id="contest-select"
              class="bg-slate-900 border border-slate-700 text-[11px] px-2 py-1 rounded-lg text-slate-200">
        <option value="">Select contest</option>
      </select>
      <button id="back-dashboard"
        class="px-3 py-1.5 rounded-lg border border-slate-700 text-[11px] text-slate-200 hover:border-emerald-400 hover:text-emerald-300">
        Back to dashboard
      </button>
    </div>
  </header>

  <!-- Contest meta -->
  <section id="contest-meta-card" class="mb-4 hidden">
    <div class="bg-slate-900/90 border border-slate-800 rounded-2xl px-4 py-3 flex flex-wrap items-center justify-between gap-3 text-xs">
      <div>
        <p id="contest-title" class="font-semibold mb-1"></p>
        <p id="contest-details" class="text-[11px] text-slate-400"></p>
      </div>
      <div class="flex items-center gap-2">
        <p id="winners-count-label" class="text-[11px] text-slate-300"></p>
        <button id="copy-csv-btn"
          class="px-3 py-1.5 rounded-lg bg-emerald-500 text-slate-900 text-[11px] font-semibold disabled:opacity-50">
          Copy winners CSV
        </button>
      </div>
    </div>
  </section>

  <!-- Winners table -->
  <section class="mt-2 text-xs">
    <h2 class="text-sm font-semibold mb-2">Winners list</h2>
    <div id="winners-body" class="border border-slate-800 rounded-xl overflow-hidden">
      <div class="px-3 py-2 text-[11px] text-slate-400">
        Select a contest to load winners.
      </div>
    </div>
  </section>
</main>

<script src="contests-config.js"></script>
<script>
  // Supabase client (same project)
  const SUPABASE_URL = 'https://tghtgygjawhrcgtwhrej.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRnaHRneWdqYXdocmNndHdocmVqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5OTM0MjksImV4cCI6MjA4MTU2OTQyOX0.Q-Ht_IFcPZPIHO5905o70EDya2yFdVP-9LjDmjkle38';
  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  let currentContest = null;
  let currentWinners = [];

  function findContestById(id) {
    return Array.isArray(CONTESTS) ? CONTESTS.find(c => c.id === id) : null;
  }

  function initContestDropdown() {
    const select = document.getElementById('contest-select');
    if (!select || !Array.isArray(CONTESTS)) return;

    CONTESTS.forEach(c => {
      const opt = document.createElement('option');
      opt.value = c.id;
      opt.textContent = `${c.title} (${c.type === 'paid' ? 'Paid' : 'Free'})`;
      select.appendChild(opt);
    });

    select.addEventListener('change', () => {
      const id = select.value;
      if (!id) {
        document.getElementById('winners-body').innerHTML =
          `<div class="px-3 py-2 text-[11px] text-slate-400">Select a contest to load winners.</div>`;
        document.getElementById('contest-meta-card').classList.add('hidden');
        currentContest = null;
        currentWinners = [];
        document.getElementById('copy-csv-btn').disabled = true;
        return;
      }
      loadWinnersForContest(id);
    });
  }

  function renderContestMeta() {
    const card = document.getElementById('contest-meta-card');
    const titleEl = document.getElementById('contest-title');
    const detailsEl = document.getElementById('contest-details');
    const winnersLabel = document.getElementById('winners-count-label');

    if (!currentContest) {
      card.classList.add('hidden');
      return;
    }

    card.classList.remove('hidden');
    titleEl.textContent = currentContest.title || '';
    detailsEl.textContent =
      `Type: ${currentContest.type === 'paid' ? 'Paid' : 'Free'} • ` +
      `Entry ${currentContest.entryFee === 0 ? 'Free' : '₹' + currentContest.entryFee} • ` +
      `Total prize ₹${currentContest.totalPrize}`;

    const maxWinners = currentContest.maxWinners || 50;
    winnersLabel.textContent = `Configured winners: Top ${maxWinners}`;
  }

  async function loadWinnersForContest(contestId) {
    const body = document.getElementById('winners-body');
    body.innerHTML = `<div class="px-3 py-2 text-[11px] text-slate-400">Loading winners...</div>`;

    currentContest = findContestById(contestId);
    renderContestMeta();

    const maxWinners = currentContest?.maxWinners || 50;

    try {
      const { data, error } = await supabaseClient
        .from('leaderboard')
        .select('user_id, score, rank')
        .eq('contest_id', contestId)
        .order('score', { ascending: false })
        .limit(maxWinners); // Top N winners[web:21][web:111]

      if (error) {
        console.error('Winners load error:', error);
        body.innerHTML = `<div class="px-3 py-2 text-[11px] text-red-400">Failed to load winners.</div>`;
        document.getElementById('copy-csv-btn').disabled = true;
        return;
      }

      if (!data || data.length === 0) {
        body.innerHTML = `<div class="px-3 py-2 text-[11px] text-slate-400">No participants / winners yet for this contest.</div>`;
        document.getElementById('copy-csv-btn').disabled = true;
        return;
      }

      // Sort + rank fallback
      data.sort((a, b) => b.score - a.score);
      currentWinners = data.map((row, index) => ({
        rank: row.rank || index + 1,
        user_id: row.user_id,
        score: row.score
      }));

      renderWinnersTable();
      document.getElementById('copy-csv-btn').disabled = false;
    } catch (e) {
      console.error('Winners exception:', e);
      body.innerHTML = `<div class="px-3 py-2 text-[11px] text-red-400">Error loading winners.</div>`;
      document.getElementById('copy-csv-btn').disabled = true;
    }
  }

  function renderWinnersTable() {
    const body = document.getElementById('winners-body');

    const rowsHtml = currentWinners.map((w) => {
      const shortId = w.user_id ? w.user_id.slice(0, 8) + '...' : '-';
      return `
        <tr class="border-t border-slate-800 hover:bg-slate-800/60">
          <td class="px-3 py-1.5 text-center text-[11px] text-emerald-400 font-semibold">#${w.rank}</td>
          <td class="px-3 py-1.5 text-[11px] text-slate-100">${shortId}</td>
          <td class="px-3 py-1.5 text-center text-[11px] text-slate-100 font-semibold">${w.score}</td>
        </tr>
      `;
    }).join('');

    body.innerHTML = `
      <table class="w-full text-[11px]">
        <thead class="bg-slate-800/80 text-slate-300">
          <tr>
            <th class="px-3 py-1.5 text-left">Rank</th>
            <th class="px-3 py-1.5 text-left">User ID (short)</th>
            <th class="px-3 py-1.5 text-left">Score</th>
          </tr>
        </thead>
        <tbody class="text-slate-200">
          ${rowsHtml}
        </tbody>
      </table>
    `;
  }

  function copyWinnersCsvToClipboard() {
    if (!currentContest || !currentWinners.length) return;

    const header = ['rank', 'user_id', 'score'];
    const lines = [header.join(',')];

    currentWinners.forEach(w => {
      lines.push(`${w.rank},${w.user_id},${w.score}`);
    });

    const csv = lines.join('\n');

    navigator.clipboard.writeText(csv)
      .then(() => {
        alert('Winners CSV copied to clipboard. Excel/Google Sheets me paste kar sakte ho.');
      })
      .catch(err => {
        console.error('Clipboard error:', err);
        alert('CSV copy nahi ho paya. Console check karo.');
      });
  }

  async function ensureAdminAccess() {
    // Optional: basic protection – sirf tumhara email allowed
    const { data, error } = await supabaseClient.auth.getUser();
    if (error || !data.user) {
      window.location.href = 'index.html';
      return;
    }

    const email = data.user.email || '';
    // Yahan apna admin email dal sakte ho
    const allowed = [/* 'youremail@example.com' */];

    if (allowed.length && !allowed.includes(email)) {
      alert('Admin panel access denied.');
      window.location.href = 'dashboard.html';
    }
  }

  document.getElementById('back-dashboard').addEventListener('click', () => {
    window.location.href = 'dashboard.html';
  });

  document.getElementById('copy-csv-btn').addEventListener('click', copyWinnersCsvToClipboard);

  document.addEventListener('DOMContentLoaded', async () => {
    await ensureAdminAccess();
    initContestDropdown();
  });
</script>

</body>
</html>
