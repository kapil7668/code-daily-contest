<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CodeRush Admin â€“ Winners & Prizes</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Supabase core + common client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="supabase-client.js"></script>
  <style>
    * { font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
    .status-pending { background: linear-gradient(90deg, #f59e0b20 0%, #fbbf2480 100%); }
    .status-paid { background: linear-gradient(90deg, #10b98120 0%, #34d39980 100%); }
    .status-disputed { background: linear-gradient(90deg, #ef444480 0%, #f9731680 100%); }
  </style>
</head>

<body class="min-h-screen text-slate-100 bg-slate-950
             bg-[radial-gradient(circle_at_top,_rgba(45,212,191,0.23),_transparent_52%),radial-gradient(circle_at_bottom,_rgba(37,99,235,0.22),_transparent_55%)]">

<!-- Admin Top Navbar -->
<header class="border-b border-slate-800/60 bg-slate-950/80 backdrop-blur sticky top-0 z-30">
  <nav class="max-w-6xl mx-auto flex items-center justify-between px-4 py-3">
    <div class="flex items-center gap-2">
      <div class="h-8 w-8 rounded-xl bg-gradient-to-br from-emerald-400 to-cyan-500 flex items-center justify-center text-slate-900 font-extrabold">
        C
      </div>
      <span class="font-semibold text-lg tracking-tight">CodeRush Admin</span>
      <span class="ml-2 px-2 py-1 bg-emerald-500/20 text-emerald-400 text-xs rounded-full font-mono">#ADMIN</span>
    </div>
    <div class="flex items-center gap-3 text-xs">
      <span id="admin-user-email" class="text-slate-300"></span>
      <button id="logout-admin" class="px-3 py-1.5 rounded-lg border border-red-500/50 hover:border-red-400 text-red-300">
        Logout
      </button>
    </div>
  </nav>
</header>

<main class="max-w-7xl mx-auto px-4 py-8">
  <!-- Stats Overview -->
  <section class="grid md:grid-cols-4 gap-4 mb-8">
    <div class="bg-slate-900/80 border border-slate-800 rounded-2xl p-6 text-center">
      <div class="text-2xl font-bold text-emerald-400 mb-1">47</div>
      <div class="text-xs text-slate-400">Contests Completed</div>
    </div>
    <div class="bg-slate-900/80 border border-slate-800 rounded-2xl p-6 text-center">
      <div class="text-2xl font-bold text-amber-400 mb-1">â‚¹12,450</div>
      <div class="text-xs text-slate-400">Total Payouts</div>
    </div>
    <div class="bg-slate-900/80 border border-slate-800 rounded-2xl p-6 text-center">
      <div class="text-2xl font-bold text-slate-300 mb-1">127</div>
      <div class="text-xs text-slate-400">Participants</div>
    </div>
    <div class="bg-slate-900/80 border border-slate-800 rounded-2xl p-6 text-center">
      <div class="text-2xl font-bold text-red-400 mb-1">2</div>
      <div class="text-xs text-slate-400">Pending Payouts</div>
    </div>
  </section>

  <div class="grid lg:grid-cols-3 gap-6">
    <!-- Left: Contest Selector + Quick Actions -->
    <section class="lg:col-span-1">
      <div class="bg-slate-900/80 border border-slate-800 rounded-2xl p-6 sticky top-24">
        <h2 class="text-lg font-bold mb-4">Contest Management</h2>
        
        <div class="space-y-3 mb-6">
          <select id="contest-select-admin" class="w-full bg-slate-950 border border-slate-700 rounded-lg px-3 py-2 text-sm">
            <option value="">Select Contest</option>
          </select>
          
          <div class="grid grid-cols-2 gap-2">
            <button id="refresh-data" class="px-3 py-2 rounded-lg border border-slate-700 hover:border-emerald-400 text-sm">
              ğŸ”„ Refresh
            </button>
            <button id="export-csv" class="px-3 py-2 rounded-lg border border-slate-700 hover:border-amber-400 text-sm">
              ğŸ“Š Export CSV
            </button>
          </div>
        </div>

        <!-- Quick Actions -->
        <div class="space-y-2">
          <h3 class="font-semibold text-sm mb-2 text-slate-300">Quick Actions</h3>
          <button id="mark-all-paid" class="w-full p-2 rounded-lg bg-emerald-500/20 border border-emerald-500/40 text-emerald-400 text-xs hover:bg-emerald-500/30">
            âœ… Mark All Paid
          </button>
          <button id="dispute-review" class="w-full p-2 rounded-lg bg-amber-500/20 border border-amber-500/40 text-amber-400 text-xs hover:bg-amber-500/30">
            âš ï¸ Review Disputes
          </button>
        </div>
      </div>
    </section>

    <!-- Right: Winners Table -->
    <section class="lg:col-span-2">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-bold">ğŸ† Winners & Payouts</h2>
        <div class="flex items-center gap-2 text-sm">
          <span id="contest-participants" class="text-slate-400">0 participants</span>
          <button id="toggle-paid-only" class="px-3 py-1 rounded-lg border border-slate-700 hover:border-emerald-400 text-xs">
            Paid Only
          </button>
        </div>
      </div>

      <div class="bg-slate-900/80 border border-slate-800 rounded-2xl overflow-hidden">
        <table id="winners-table" class="w-full text-xs">
          <thead class="bg-slate-800/80 sticky top-0 z-10">
            <tr>
              <th class="px-4 py-3 text-left font-semibold text-slate-300">Rank</th>
              <th class="px-4 py-3 text-left font-semibold text-slate-300">Contestant</th>
              <th class="px-4 py-3 text-left font-semibold text-slate-300">Score</th>
              <th class="px-4 py-3 text-left font-semibold text-slate-300">Prize</th>
              <th class="px-4 py-3 text-left font-semibold text-slate-300">Status</th>
              <th class="px-4 py-3 text-left font-semibold text-slate-300">Actions</th>
            </tr>
          </thead>
          <tbody id="winners-tbody">
            <tr>
              <td colspan="6" class="px-4 py-12 text-center text-slate-500">
                Select a contest to view winners
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>
  </div>

  <!-- Payment Modal -->
  <div id="payment-modal" class="fixed inset-0 bg-black/80 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-slate-900 border border-slate-800 rounded-2xl p-6 max-w-sm w-full">
      <h3 class="text-lg font-bold mb-4">Mark as Paid</h3>
      <div id="payment-details" class="mb-4 p-3 bg-slate-800/50 rounded-lg text-sm"></div>
      <div class="flex gap-3 pt-4 border-t border-slate-800">
        <button id="confirm-payment" class="flex-1 bg-emerald-500 text-slate-900 py-2 rounded-lg font-semibold">
          âœ… Confirm Paid
        </button>
        <button id="cancel-payment" class="flex-1 border border-slate-700 py-2 rounded-lg text-slate-300">
          Cancel
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  const supabaseClient = window.supabaseClient;
  let currentContestId = null;
  let winnersData = [];

  // ===== Admin Auth Check =====
  document.addEventListener('DOMContentLoaded', async () => {
    const user = await window.requireAuth();
    if (!user) return;
    
    // Admin check (email-based for demo)
    if (!user.email.includes('@admin') && user.email !== 'admin@coderush.in') {
      alert('Admin access required');
      window.location.href = 'dashboard.html';
      return;
    }
    
    document.getElementById('admin-user-email').textContent = user.email;
    initAdminPanel();
  });

  async function initAdminPanel() {
    await loadContestDropdown();
    document.getElementById('logout-admin').onclick = () => window.logoutAndRedirect('index.html');
  }

  // ===== Contest Dropdown =====
  async function loadContestDropdown() {
    const select = document.getElementById('contest-select-admin');
    const { data } = await supabaseClient
      .from('leaderboard')
      .select('contest_id')
      .order('contest_id', { ascending: false })
      .limit(20);

    const contests = [...new Set(data?.map(row => row.contest_id) || [])];
    contests.forEach(contestId => {
      const option = document.createElement('option');
      option.value = contestId;
      option.textContent = contestId;
      select.appendChild(option);
    });

    select.onchange = () => loadWinners(select.value);
  }

  // ===== Load Winners Table =====
  async function loadWinners(contestId) {
    if (!contestId) return;
    currentContestId = contestId;
    
    try {
      const { data, error } = await supabaseClient
        .from('leaderboard')
        .select(`
          user_id,
          score,
          rank,
          contest_id,
          payouts (*)
        `)
        .eq('contest_id', contestId)
        .order('score', { ascending: false });

      if (error) throw error;
      
      winnersData = data || [];
      document.getElementById('contest-participants').textContent = `${winnersData.length} participants`;
      
      renderWinnersTable();
    } catch (error) {
      console.error('Load winners error:', error);
      showError('Failed to load winners');
    }
  }

  function renderWinnersTable() {
    const tbody = document.getElementById('winners-tbody');
    
    if (winnersData.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="6" class="px-4 py-12 text-center text-slate-500">
            No participants yet
          </td>
        </tr>
      `;
      return;
    }

    const prizeStructure = {
      1: 'â‚¹500', 2: 'â‚¹250', 3: 'â‚¹100', 4: 'â‚¹50'
    };

    const rows = winnersData.slice(0, 50).map((winner, index) => {
      const rank = winner.rank || index + 1;
      const prize = rank <= 4 ? prizeStructure[rank] : '-';
      const payout = winner.payouts?.[0];
      const status = payout?.status || 'pending';
      
      return `
        <tr class="border-t border-slate-800 hover:bg-slate-800/50 transition-colors ${status === 'paid' ? 'status-paid' : ''}">
          <td class="px-4 py-3 font-mono font-bold text-emerald-400">${rank}</td>
          <td class="px-4 py-3">
            <div class="font-mono text-sm">${winner.user_id.slice(0,12)}...</div>
            <div class="text-[11px] text-slate-500">${winner.user_id}</div>
          </td>
          <td class="px-4 py-3 font-mono font-bold">${winner.score}</td>
          <td class="px-4 py-3 font-semibold">${prize}</td>
          <td class="px-4 py-3">
            <span class="px-2 py-1 rounded-full text-[11px] font-semibold
                  ${status === 'paid' ? 'bg-emerald-500/30 text-emerald-400 border border-emerald-500/50' : 
                    status === 'disputed' ? 'bg-amber-500/30 text-amber-400 border border-amber-500/50' : 
                    'bg-amber-500/20 text-amber-400 border border-amber-500/30'}">
              ${status === 'paid' ? 'âœ… Paid' : status === 'disputed' ? 'âš ï¸ Disputed' : 'â³ Pending'}
            </span>
          </td>
          <td class="px-4 py-3">
            <div class="flex items-center gap-1">
              ${status !== 'paid' ? 
                `<button onclick="showPaymentModal(${rank})" 
                         class="px-2 py-1 rounded text-[11px] bg-emerald-500/20 border border-emerald-500/40 text-emerald-400 hover:bg-emerald-500/40">
                  ğŸ’° Pay Now
                </button>` : ''}
              <button onclick="copyUserId('${winner.user_id}')" 
                      class="px-1.5 py-1 rounded text-[10px] border border-slate-600 hover:border-slate-400 text-slate-400">
                ğŸ“‹
              </button>
            </div>
          </td>
        </tr>
      `;
    }).join('');

    tbody.innerHTML = rows;
  }

  // ===== Payment Modal =====
  function showPaymentModal(rank) {
    const winner = winnersData.find(w => (w.rank || winnersData.indexOf(w) + 1) === rank);
    if (!winner) return;

    document.getElementById('payment-details').innerHTML = `
      <div class="space-y-2">
        <div><strong>User:</strong> ${winner.user_id}</div>
        <div><strong>Rank:</strong> #${rank}</div>
        <div><strong>Score:</strong> ${winner.score}</div>
        <div><strong>Prize:</strong> â‚¹${rank === 1 ? 500 : rank === 2 ? 250 : rank === 3 ? 100 : 50}</div>
      </div>
    `;
    
    document.getElementById('payment-modal').classList.remove('hidden');
    document.getElementById('confirm-payment').onclick = () => confirmPayment(winner, rank);
  }

  async function confirmPayment(winner, rank) {
    try {
      const prize = rank === 1 ? 500 : rank === 2 ? 250 : rank === 3 ? 100 : 50;
      
      await supabaseClient.from('payouts').upsert({
        contest_id: currentContestId,
        user_id: winner.user_id,
        rank: rank,
        amount: prize,
        status: 'paid',
        paid_at: new Date().toISOString(),
        admin_id: (await window.getCurrentUser()).id
      });

      document.getElementById('payment-modal').classList.add('hidden');
      loadWinners(currentContestId); // Refresh table
      showSuccess(`â‚¹${prize} paid to ${winner.user_id.slice(0,12)}...`);
    } catch (error) {
      showError('Payment update failed');
    }
  }

  document.getElementById('cancel-payment').onclick = () => {
    document.getElementById('payment-modal').classList.add('hidden');
  };

  // ===== Utility Functions =====
  function copyUserId(userId) {
    navigator.clipboard.writeText(userId);
    showSuccess('User ID copied!');
  }

  function showSuccess(message) {
    // Simple toast (implement as needed)
    console.log('âœ…', message);
  }

  function showError(message) {
    console.error('âŒ', message);
  }

  // ===== Event Listeners =====
  document.getElementById('refresh-data').onclick = () => loadWinners(currentContestId);
  document.getElementById('mark-all-paid').onclick = () => {
    if (confirm('Mark all top 4 as paid?')) markAllPaid();
  };

  async function markAllPaid() {
    const top4 = winnersData.slice(0, 4);
    const payouts = top4.map((w, i) => ({
      contest_id: currentContestId,
      user_id: w.user_id,
      rank: i + 1,
      amount: [500, 250, 100, 50][i],
      status: 'paid',
      paid_at: new Date().toISOString()
    }));

    await supabaseClient.from('payouts').upsert(payouts);
    loadWinners(currentContestId);
  }
</script>

</body>
</html>
