<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin – Contest Winners | CodeRush</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.48.0/dist/umd/supabase.min.js"></script>
  <style>
    * { font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
  </style>
</head>

<body class="min-h-screen text-slate-100 bg-slate-950
             bg-[radial-gradient(circle_at_top,_rgba(45,212,191,0.23),_transparent_52%),radial-gradient(circle_at_bottom,_rgba(37,99,235,0.22),_transparent_55%)]">

<main class="max-w-5xl mx-auto px-4 py-6 mt-6 mb-10 bg-slate-900/85 border border-slate-800/60 rounded-2xl shadow-[0_0_40px_rgba(15,23,42,0.95)]">

  <!-- Header -->
  <header class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
    <div>
      <h1 class="text-xl md:text-2xl font-bold mb-1">Admin – Contest Winners</h1>
      <p class="text-slate-300 text-xs md:text-sm">
        Select a contest to see top ranks, scores, prize amounts and payout status.
      </p>
    </div>
    <div class="text-[11px] text-slate-400">
      <p>Note: Only admins should access this page.</p>
    </div>
  </header>

  <!-- Contest selector -->
  <section class="mb-4">
    <div class="flex flex-col md:flex-row md:items-center gap-3">
      <div class="flex-1">
        <label for="admin-contest-select" class="block text-xs text-slate-300 mb-1">Select contest</label>
        <select id="admin-contest-select"
                class="w-full bg-slate-900 border border-slate-700 text-[11px] px-2 py-1.5 rounded-lg text-slate-200">
          <option value="">-- Choose a contest --</option>
        </select>
      </div>

      <div class="flex gap-2 text-[11px]">
        <button id="copy-csv-btn"
                class="px-3 py-1.5 rounded-lg border border-slate-600 text-slate-200 hover:border-emerald-400 hover:text-emerald-300 disabled:opacity-40">
          Copy as CSV
        </button>
        <button id="refresh-btn"
                class="px-3 py-1.5 rounded-lg border border-slate-600 text-slate-200 hover:border-sky-400 hover:text-sky-300 disabled:opacity-40">
          Refresh
        </button>
      </div>
    </div>

    <p id="contest-meta" class="mt-2 text-[11px] text-slate-400">
      No contest selected.
    </p>
  </section>

  <!-- Winners table -->
  <section id="winners-section" class="mt-4">
    <h2 class="text-sm font-semibold mb-2">Winners list</h2>
    <div id="winners-body" class="text-xs text-slate-200">
      <p class="text-[11px] text-slate-400">Select a contest to load winners.</p>
    </div>
  </section>

</main>

<script src="contests-config.js"></script>
<script>
  // Supabase client
  const SUPABASE_URL = 'https://tghtgygjawhrcgtwhrej.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRnaHRneWdqYXdocmNndHdocmVqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5OTM0MjksImV4cCI6MjA4MTU2OTQyOX0.Q-Ht_IFcPZPIHO5905o70EDya2yFdVP-9LjDmjkle38';
  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // Admin email – sirf isi se login hone par page chalega
  const ADMIN_EMAIL = 'kapilrajputana35@gmail.com';

  const contestSelect = document.getElementById('admin-contest-select');
  const winnersBody = document.getElementById('winners-body');
  const contestMeta = document.getElementById('contest-meta');
  const copyCsvBtn = document.getElementById('copy-csv-btn');
  const refreshBtn = document.getElementById('refresh-btn');

  let lastWinnersData = []; // CSV ke लिए cache

  // -------- ADMIN ACCESS CHECK --------
  (async () => {
    try {
      const { data } = await supabaseClient.auth.getUser(); // current user lana [web:378]

      if (!data || !data.user) {
        alert('Please sign in as admin to view this page.');
        window.location.href = 'index.html';
        return;
      }

      const email = data.user.email;

      if (email !== ADMIN_EMAIL) {
        alert('You are not allowed to access this page.');
        window.location.href = 'index.html';
        return;
      }

      console.log('Admin verified:', email);
    } catch (e) {
      console.error('Admin check failed', e);
      window.location.href = 'index.html';
    }
  })();

  // -------- HELPERS --------
  function findContestById(id) {
    return Array.isArray(CONTESTS) ? CONTESTS.find(c => c.id === id) : null;
  }

  function getPayoutForRank(contest, rank) {
    if (!contest || !Array.isArray(contest.payouts)) return 0;
    for (const p of contest.payouts) {
      if (rank >= p.fromRank && rank <= p.toRank) {
        return p.amount || 0;
      }
    }
    return 0;
  }

  // payout record read karne ke लिए map bana lo: key = contest_id + user_id + rank
  function makePayoutKey(contestId, userId, rank) {
    return `${contestId}::${userId || 'none'}::${rank}`;
  }

  async function fetchPayoutStatus(contestId, winners) {
    if (!winners.length) return {};

    const userIds = winners.map(w => w.user_id).filter(Boolean);

    const { data, error } = await supabaseClient
      .from('payouts')
      .select('contest_id,user_id,rank,is_paid')
      .eq('contest_id', contestId)
      .in('user_id', userIds);

    if (error) {
      console.error('Fetch payouts error:', error);
      return {};
    }

    const map = {};
    for (const row of data) {
      const key = makePayoutKey(row.contest_id, row.user_id, row.rank);
      map[key] = !!row.is_paid;
    }
    return map;
  }

  async function togglePayout(contestId, winner) {
    const key = makePayoutKey(contestId, winner.user_id, winner.rank);

    // Current status know karne ke लिए payouts table se row le aate hain
    const { data, error } = await supabaseClient
      .from('payouts')
      .select('id,is_paid')
      .eq('contest_id', contestId)
      .eq('user_id', winner.user_id)
      .eq('rank', winner.rank)
      .maybeSingle();

    if (error && error.code !== 'PGRST116') { // no rows return wali error ignore [web:378]
      console.error('Read payout row error:', error);
      alert('Failed to update payout.');
      return;
    }

    const currentlyPaid = data ? !!data.is_paid : false;
    const nextPaid = !currentlyPaid;

    let upsertError;

    if (data && data.id) {
      // update existing
      const { error: updErr } = await supabaseClient
        .from('payouts')
        .update({ is_paid: nextPaid })
        .eq('id', data.id);
      upsertError = updErr;
    } else {
      // insert new
      const { error: insErr } = await supabaseClient
        .from('payouts')
        .insert({
          contest_id: contestId,
          user_id: winner.user_id,
          rank: winner.rank,
          prize_amount: winner.prize,
          is_paid: nextPaid
        });
      upsertError = insErr;
    }

    if (upsertError) {
      console.error('Upsert payout error:', upsertError);
      alert('Failed to update payout.');
      return;
    }

    // UI refresh
    await loadWinners(contestId);
  }

  function initContestOptions() {
    if (!contestSelect || !Array.isArray(CONTESTS)) return;

    CONTESTS.forEach(c => {
      const opt = document.createElement('option');
      opt.value = c.id;
      opt.textContent = `${c.title} – ${c.type === 'paid' ? 'Paid' : 'Free'} (ID: ${c.id})`;
      contestSelect.appendChild(opt);
    });

    contestSelect.addEventListener('change', () => {
      const id = contestSelect.value;
      if (!id) {
        contestMeta.textContent = 'No contest selected.';
        winnersBody.innerHTML = `<p class="text-[11px] text-slate-400">Select a contest to load winners.</p>`;
        copyCsvBtn.disabled = true;
        refreshBtn.disabled = true;
        lastWinnersData = [];
        return;
      }
      loadWinners(id);
    });

    refreshBtn.addEventListener('click', () => {
      const id = contestSelect.value;
      if (id) loadWinners(id);
    });

    copyCsvBtn.addEventListener('click', () => {
      if (!lastWinnersData.length) return;
      const header = ['rank','user_id','score','prize_amount','is_paid'];
      const lines = [header.join(',')].concat(
        lastWinnersData.map(r => [r.rank, r.user_id, r.score, r.prize, r.is_paid ? 'true' : 'false'].join(','))
      );
      const csv = lines.join('\n');
      navigator.clipboard.writeText(csv).then(() => {
        alert('CSV copied to clipboard.');
      }).catch(() => {
        alert('Failed to copy CSV.');
      });
    });
  }

  // -------- LOAD WINNERS + PAYOUT STATUS FROM SUPABASE --------
  async function loadWinners(contestId) {
    const contest = findContestById(contestId);
    if (!contest) {
      contestMeta.textContent = 'Invalid contest selected.';
      winnersBody.innerHTML = `<p class="text-[11px] text-red-400">Invalid contest configuration.</p>`;
      return;
    }

    winnersBody.innerHTML = `<p class="text-[11px] text-slate-400">Loading winners...</p>`;
    copyCsvBtn.disabled = true;
    refreshBtn.disabled = true;

    contestMeta.textContent = `Contest: ${contest.title} • Entry ₹${contest.entryFee} • Total prize ₹${contest.totalPrize} • Max winners: ${contest.maxWinners}`;

    try {
      const { data, error } = await supabaseClient
        .from('leaderboard')
        .select('user_id, score, rank, created_at')
        .eq('contest_id', contestId)
        .order('score', { ascending: false });

      if (error) {
        console.error('Load winners error:', error);
        winnersBody.innerHTML = `<p class="text-[11px] text-red-400">Failed to load leaderboard.</p>`;
        return;
      }

      if (!data || data.length === 0) {
        winnersBody.innerHTML = `<p class="text-[11px] text-slate-400">No participants yet for this contest.</p>`;
        lastWinnersData = [];
        return;
      }

      // Rank fallback + prize mapping
      const sorted = [...data].sort((a, b) => b.score - a.score || new Date(a.created_at) - new Date(b.created_at));
      let winners = sorted.map((row, index) => {
        const rank = row.rank || index + 1;
        const prize = getPayoutForRank(contest, rank);
        return {
          rank,
          user_id: row.user_id,
          score: row.score || 0,
          prize,
          is_paid: false
        };
      }).filter(r => r.rank <= contest.maxWinners);

      // payout status merge karo
      const payoutMap = await fetchPayoutStatus(contestId, winners);
      winners = winners.map(w => {
        const key = makePayoutKey(contestId, w.user_id, w.rank);
        return { ...w, is_paid: !!payoutMap[key] };
      });

      lastWinnersData = winners;
      copyCsvBtn.disabled = winners.length === 0;
      refreshBtn.disabled = false;

      if (!winners.length) {
        winnersBody.innerHTML = `<p class="text-[11px] text-slate-400">No winners configured for this contest (maxWinners = 0).</p>`;
        return;
      }

      const rowsHtml = winners.map(w => {
        const displayId = w.user_id ? w.user_id.slice(0, 6) + '...' : 'User';
        const prizeText = w.prize > 0 ? `₹${w.prize}` : '-';
        const paidBadge = w.is_paid
          ? '<span class="px-2 py-0.5 rounded-full text-[10px] bg-emerald-500/15 text-emerald-300 border border-emerald-500/40">Paid</span>'
          : '<span class="px-2 py-0.5 rounded-full text-[10px] bg-amber-500/10 text-amber-300 border border-amber-500/30">Unpaid</span>';

        return `
          <tr class="border-t border-slate-800 hover:bg-slate-800/60">
            <td class="px-3 py-1.5 text-center text-[11px] text-emerald-400 font-semibold">#${w.rank}</td>
            <td class="px-3 py-1.5 text-[11px] text-slate-200">${displayId}</td>
            <td class="px-3 py-1.5 text-center text-[11px] text-slate-100 font-semibold">${w.score}</td>
            <td class="px-3 py-1.5 text-center text-[11px] text-amber-300 font-semibold">${prizeText}</td>
            <td class="px-3 py-1.5 text-center text-[11px]">
              <button
                class="px-2 py-0.5 rounded-md text-[10px] border ${w.is_paid ? 'border-slate-600 text-slate-300 bg-slate-800/60' : 'border-emerald-500/60 text-emerald-300 bg-emerald-500/10'}"
                data-user-id="${w.user_id}"
                data-rank="${w.rank}">
                ${paidBadge}
              </button>
            </td>
          </tr>
        `;
      }).join('');

      winnersBody.innerHTML = `
        <div class="border border-slate-800 rounded-xl overflow-hidden">
          <table class="w-full text-[11px]">
            <thead class="bg-slate-800/80 text-slate-300">
              <tr>
                <th class="px-3 py-1.5 text-left">Rank</th>
                <th class="px-3 py-1.5 text-left">User ID (short)</th>
                <th class="px-3 py-1.5 text-left">Score</th>
                <th class="px-3 py-1.5 text-left">Prize</th>
                <th class="px-3 py-1.5 text-left">Paid?</th>
              </tr>
            </thead>
            <tbody>
              ${rowsHtml}
            </tbody>
          </table>
        </div>
      `;

      // Button click listeners (delegation)
      winnersBody.querySelectorAll('button[data-user-id]').forEach(btn => {
        btn.addEventListener('click', () => {
          const userId = btn.getAttribute('data-user-id');
          const rank = parseInt(btn.getAttribute('data-rank'), 10);
          const winner = winners.find(w => w.user_id === userId && w.rank === rank);
          if (winner) {
            togglePayout(contestId, winner);
          }
        });
      });

    } catch (e) {
      console.error('Winners render error:', e);
      winnersBody.innerHTML = `<p class="text-[11px] text-red-400">Error loading winners.</p>`;
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    initContestOptions();
  });
</script>

</body>
</html>
